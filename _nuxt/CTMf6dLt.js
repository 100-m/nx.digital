import{f as W,s as se,v as ae,r as K,x as te,o as V,c as z,a as y,F as B,l as A,t as U,b as I,i as k,k as q,w,d as O,y as X,h as P,z as ne,A as j,m as J,n as ce,B as be,C as D,D as _e,E as ye,G as H,H as xe,I as ge,J as ke,g as N,K as we,L as $e,M as oe,N as de,j as Ve,O as le,P as T,Q as L,R as Ce,S as Ee,T as Ue,U as Ie,V as Y,W as G}from"./CefpzQTw.js";import ze from"./CUFJqnPb.js";import pe from"./DAL3UMnu.js";import Me from"./C7vjiPeW.js";import je from"./DVd-JqpT.js";import Se from"./1nFVtaGg.js";import Oe from"./DgsvudIg.js";import{_ as Ke}from"./Dk-hn-j2.js";import Fe from"./sdfBXk1W.js";import{_ as Pe}from"./CvoJ3Zi1.js";import"./CcEZDszA.js";const Ae={class:"z-40 w-full max-w-full flex-none rounded bg-white px-3 py-2 shadow"},Ne={class:"max-w-full @container"},Re={class:"flex w-full flex-nowrap gap-x-3"},Be={class:"flex min-w-[150px] flex-1 flex-col gap-y-2"},De=["for"],qe={class:"truncate"},Te={class:"mt-auto flex items-center"},Le={for:"count",class:"cursor-pointer select-none px-2 font-medium"},We={class:"mb-1 flex items-center border-b border-stone-300 transition hover:bg-primary-100"},Qe=["for"],Ye=["id","name","indeterminate","checked","onInput"],Ge={class:"truncate"},Xe={class:"flex flex-1 cursor-pointer select-none items-center gap-x-2 truncate text-sm leading-tight text-stone-800"},He={key:0,class:"ml-px text-2xs"},Je={class:"truncate"},Ze={class:"flex flex-col"},et=["for"],tt=["name","id","checked","onChange"],nt={key:0,class:"ml-px text-2xs"},ot={class:"truncate"},st=10,re=6,at=40,lt=W({__name:"nx-crud-filter",props:se({filters:{}},{modelValue:{default:[]},modelModifiers:{}}),emits:["update:modelValue"],setup(p){const u=ae(p,"modelValue"),d=K([]),m=K(!1);te("filterChoices",d),te("filterPercentage",m);function v(e,i){const l=e.map("number").max();return Math.round(i*at/l)}function f(e,i){const l=e.sum("number");return Math.round(i/l*100)||0}function g(e){const i=u.value.filter(l=>!l.startsWith(e.name));if(r(e))return u.value=i;u.value=i.concat(e.options.map("id"))}function x(e,i){const l=u.value.findIndex(b=>b===e.id);l===-1?u.value.push(e.id):u.value.splice(l,1),setTimeout(()=>{i.target.checked=!!i.target.attributes.checked},0)}function n(e){return u.value.includes(e.id)}function s(e){const i=u.value.filter(l=>l.startsWith(e.name));return e.options.length!==i.length&&i.length>0}function r(e){const i=u.value.filter(l=>l.startsWith(e.name));return e.options.length===i.length}function o(e,i){const l=a(e);if(!l)return u.value=u.value.concat(i);const b=u.value.filter(_=>!_.startsWith(e.name));if(i===l)return u.value=b;u.value=b.concat(i)}function a(e){const i=u.value.find(l=>l.startsWith(e.name));if(i)return i;if(e.name!=="Working Date")return e.options[0].id}const t=["hidden @[400px]:inline","hidden @[600px]:inline","hidden @[800px]:inline","hidden @[1000px]:inline","hidden @[1200px]:inline","hidden @[1400px]:inline","hidden @[1600px]:inline","hidden @[1800px]:inline","hidden @[2000px]:inline","hidden @[2200px]:inline"];return(e,i)=>{const l=pe,b=Me,_=J,C=ce;return V(),z("div",Ae,[y("div",Ne,[y("div",Re,[y("div",Be,[(V(!0),z(B,null,A(e.filters.filter(h=>h.component==="single"),(h,E)=>(V(),z("div",null,[y("label",{for:"section-"+h.name,class:"flex flex-1 select-none items-center gap-x-2 truncate py-1 pl-1 font-medium capitalize"},[y("span",qe,U(h.name),1)],8,De),I(l,{searchable:"",id:"section-"+h.name,name:h.name,"model-value":a(h),onChange:c=>o(h,c),"value-attribute":"id","search-attributes":["label"],options:h.options},null,8,["id","name","model-value","onChange","options"])]))),256)),y("div",Te,[I(b,{id:"count",size:"md","on-icon":"i-carbon/percentage","off-icon":"i-carbon/character-whole-number",ui:{inactive:"bg-primary",active:"bg-primary",icon:{on:"text-stone-700",off:"text-stone-700"}},modelValue:k(m),"onUpdate:modelValue":i[0]||(i[0]=h=>q(m)?m.value=h:null)},null,8,["modelValue"]),y("label",Le,U(k(m)?"Percent":"Count"),1),I(_,{class:"ml-auto",variant:"solid",size:"2xs",color:"stone",onClick:i[1]||(i[1]=h=>u.value=[])},{default:w(()=>[O(U(e.t.reset),1)]),_:1})])]),(V(!0),z(B,null,A(e.filters.filter(h=>!h.component).slice(0,st-1).map((h,E)=>e.filters.find(c=>c.name===k(d)[E])??h),(h,E)=>(V(),z("div",{class:X(["min-w-[200px] flex-1",t[E]])},[y("div",We,[y("label",{for:"section-"+h.name,class:"flex flex-1 cursor-pointer select-none items-center gap-x-2 truncate py-1 pl-1 font-medium capitalize"},[y("input",{id:"section-"+h.name,name:h.name,indeterminate:s(h),checked:r(h),onInput:c=>g(h),type:"checkbox",class:"h-3.5 w-3.5 cursor-pointer rounded border-stone-400 text-primary focus:ring-1 focus:ring-primary"},null,40,Ye),y("span",Ge,U(h.name),1)],8,Qe),h.options.length>re?(V(),P(C,{key:0,uiMenu:{width:"w-[200px] !-mr-6"},variant:"none",size:"2xs",modelValue:u.value,"onUpdate:modelValue":i[2]||(i[2]=c=>u.value=c),options:h.options,searchable:"",multiple:"","value-attribute":"id","search-attributes":["label"]},{option:w(({option:c})=>[y("label",Xe,[y("div",{class:X(["h-[14px] min-w-[18px] truncate rounded-sm px-0.5 text-xs ordinal tabular-nums leading-[14px] text-white",c.color??"bg-primary"]),style:ne(`width:${v(h.options,c.number)}px`)},[y("span",null,U(k(m)?f(h.options,c.number):c.number),1),k(m)?(V(),z("span",He,"%")):j("",!0)],6),y("span",Je,U(c.label),1)])]),default:w(()=>[I(_,{size:"xs",color:"stone",variant:"link",class:"z-10 -mx-2 truncate"},{default:w(()=>[O(U(e.t.see_more),1)]),_:1})]),_:2},1032,["modelValue","options"])):j("",!0),I(C,{modelValue:k(d)[E]??h.name,options:e.filters.filter(c=>!c.component).map(c=>c.name),uiMenu:{width:"w-[200px]"},onChange:c=>k(d)[E]=k(d)[E]===c?null:c},{default:w(()=>[I(_,{icon:"i-carbon/chevron-down",size:"xs",color:"white",variant:"soft",class:"hover:text-primary-700"})]),_:2},1032,["modelValue","options","onChange"])]),y("ul",Ze,[(V(!0),z(B,null,A(h.options.slice(0,re),c=>(V(),z("li",null,[y("label",{for:c.label,class:"flex flex-1 cursor-pointer select-none items-center gap-x-2 px-1 py-0.5 text-sm leading-tight text-stone-800 hover:bg-primary-100"},[y("input",{name:c.label,id:c.label,type:"checkbox",checked:n(c),onChange:M=>x(c,M),class:"h-3.5 w-3.5 flex-none cursor-pointer rounded border-stone-400 text-primary focus:ring-1 focus:ring-primary"},null,40,tt),y("div",{class:X(["h-[14px] min-w-[18px] truncate rounded-sm px-0.5 text-xs ordinal tabular-nums leading-[14px] text-white",c.color??"bg-primary"]),style:ne(`width:${v(h.options,c.number)}px`)},[y("span",null,U(k(m)?f(h.options,c.number):c.number),1),k(m)?(V(),z("span",nt,"%")):j("",!0)],6),y("span",ot,U(c.label),1)],8,et)]))),256))])],2))),256))])])])}}}),rt=()=>{const p=D(()=>navigator&&navigator.userAgent&&navigator.userAgent.match(/Macintosh;/)),u=K(" "),d=_e(),m=D(()=>{var x,n,s;const v=(x=d.value)==null?void 0:x.tagName,f=(n=d.value)==null?void 0:n.contentEditable;return v==="INPUT"||v==="TEXTAREA"||f==="true"||f==="plaintext-only"?((s=d.value)==null?void 0:s.name)||!0:!1});return ye(()=>{u.value=p.value?"âŒ˜":"Ctrl"}),{macOS:p,metaSymbol:u,activeElement:d,usingInput:m}},fe=be(rt);function it(...p){return D(()=>p.every(u=>H(u)))}function ut(p){return D(()=>!H(p))}const ct=/^[^-]+.*-.*[^-]+$/,dt=/^[^_]+.*_.*[^_]+$/,pt=(p,u={})=>{const{macOS:d,usingInput:m}=fe();let v=[];const f=K([]),g=()=>{f.value.splice(0,f.value.length)},x=xe(g,u.chainDelay??800),n=s=>{if(!s.key)return;const r=/^[a-z]{1}$/i.test(s.key);let o;if(f.value.push(s.key),f.value.length>=2){o=f.value.slice(-2).join("-");for(const a of v.filter(t=>t.chained))if(a.key===o){a.condition.value&&(s.preventDefault(),a.handler()),g();return}}for(const a of v.filter(t=>!t.chained))if(s.key.toLowerCase()===a.key&&s.metaKey===a.metaKey&&s.ctrlKey===a.ctrlKey&&!(r&&s.shiftKey!==a.shiftKey)){a.condition.value&&(s.preventDefault(),a.handler()),g();return}x()};v=Object.entries(p).map(([s,r])=>{var e,i;if(!r)return null;let o;s.includes("-")&&s!=="-"&&!((e=s.match(ct))!=null&&e.length)&&console.trace(`[Shortcut] Invalid key: "${s}"`),s.includes("_")&&s!=="_"&&!((i=s.match(dt))!=null&&i.length)&&console.trace(`[Shortcut] Invalid key: "${s}"`);const a=s.includes("-")&&s!=="-";if(a)o={key:s.toLowerCase(),metaKey:!1,ctrlKey:!1,shiftKey:!1,altKey:!1};else{const l=s.toLowerCase().split("_").map(b=>b);o={key:l.filter(b=>!["meta","ctrl","shift","alt"].includes(b)).join("_"),metaKey:l.includes("meta"),ctrlKey:l.includes("ctrl"),shiftKey:l.includes("shift"),altKey:l.includes("alt")}}if(o.chained=a,!d.value&&o.metaKey&&!o.ctrlKey&&(o.metaKey=!1,o.ctrlKey=!0),typeof r=="function"?o.handler=r:typeof r=="object"&&(o={...o,handler:r.handler}),!o.handler)return console.trace("[Shortcut] Invalid value"),null;const t=[];return r.usingInput?typeof r.usingInput=="string"&&t.push(D(()=>m.value===r.usingInput)):t.push(ut(m)),o.condition=it(...t,...r.whenever||[]),o}).filter(Boolean),ge("keydown",n)},ft={class:"flex flex-none flex-col items-center justify-between gap-3 md:flex-row"},mt={class:"flex flex-col"},ht={class:"truncate text-3xl font-black"},vt={class:"-mb-2 text-lg/tight text-stone-700"},bt={key:0,class:"flex md:w-[320px] lg:w-1/2"},_t={key:0,class:"flex w-full items-center pr-4"},yt={class:"mr-auto truncate"},xt={key:1},gt={class:"truncate"},kt={class:"flex items-center gap-0.5"},wt={class:"rounded border border-stone-300 bg-white px-4 py-3 shadow @container"},$t={class:"grid grid-cols-1 gap-1 @[400px]:grid-cols-2"},Vt=["for"],Ct={key:0,class:"truncate"},Et={class:"truncate"},Ut={key:0,class:"h-7"},It={class:"m-auto mr-0 flex gap-x-2"},zt=W({__name:"nx-crud-filters",props:se({filters:{}},{modelValue:{default:[]},modelModifiers:{}}),emits:["update:modelValue"],setup(p){const u=ae(p,"modelValue"),d=p,{page:m}=ke(),v=K(!1),f=K(!1);te("retractFilter",f);const g=K({});N(g,()=>{const n=Object.values(g.value).flat();Object.equal(n,u.value)||(u.value=n)},{deep:!0}),N([u,d],()=>{const n=d.filters.reduce((r,o)=>(r[o.name]=[],r),{}),s=u.value.reduce((r,o)=>{const[a,t]=o.split("|");return r[a].push(o),r},n);g.value=s},{immediate:!0});const{metaSymbol:x}=fe();return pt({meta_k:{usingInput:!0,handler:()=>$("#search").click()},escape:{usingInput:!0,whenever:[v],handler:()=>v.value=!1}}),(n,s)=>{const r=J,o=ze,a=pe,t=ce,e=$e,i=lt;return V(),z(B,null,[y("div",ft,[y("div",mt,[y("h1",ht,U(n.t[k(m).meta.title+"_title"]),1),y("h2",vt,U(n.t[k(m).meta.title+"_subtitle"]),1)]),n.filters.length?(V(),z("div",bt,[I(r,{class:"text-stone-600",size:"md",color:"white",icon:k(f)?"i-carbon/filter-remove":"i-carbon/filter",ui:{rounded:"rounded-r-none -mr-px"},tooltip:k(f)?n.t.show_filter:n.t.hide_filter,onClick:s[0]||(s[0]=l=>f.value=!k(f))},null,8,["icon","tooltip"]),I(a,{id:"search",name:"search",class:"w-[calc(100%-80px)]",ui:{rounded:"rounded-none z-10"},icon:"i-carbon/search",size:"lg",searchable:"",multiple:"",placeholder:n.t.search,modelValue:u.value,"onUpdate:modelValue":s[2]||(s[2]=l=>u.value=l),"value-attribute":"id","search-attributes":["filter","label"],options:n.filters.flatMap(l=>l.options)},{label:w(()=>[u.value.length?(V(),z("div",_t,[y("div",yt,U(u.value.map(l=>l.split("|")[1]).join(", ")),1),I(r,{class:"-my-1 mx-1",variant:"solid",size:"2xs",color:"stone",onClick:s[1]||(s[1]=we(l=>u.value=[],["stop"]))},{default:w(()=>[O(U(n.t.reset),1)]),_:1})])):(V(),z("span",xt,"Add filter"))]),option:w(({option:l})=>[y("span",gt,[y("b",null,U(l.filter),1),O(" | "+U(l.label||"-"),1)])]),trailing:w(()=>[y("div",kt,[I(o,null,{default:w(()=>[O(U(k(x)),1)]),_:1}),I(o,null,{default:w(()=>s[6]||(s[6]=[O("K")])),_:1})])]),_:1},8,["placeholder","modelValue","options"]),I(e,{open:k(v),"onUpdate:open":s[4]||(s[4]=l=>q(v)?v.value=l:null),popper:{placement:"bottom-end"},ui:{container:"w-2/3 lg:w-1/2 mr-1"}},{panel:w(({close:l})=>[y("div",wt,[y("div",$t,[(V(!0),z(B,null,A(n.filters,b=>(V(),z("div",{class:"grid grid-cols-[35%_65%] gap-x-2",key:b.name},[y("label",{for:b.name,class:"place-self-end self-center text-right text-sm font-medium"},U(b.name),9,Vt),I(t,{id:b.name,searchable:"",multiple:"",modelValue:k(g)[b.name],"onUpdate:modelValue":_=>k(g)[b.name]=_,options:b.options,"value-attribute":"id","search-attributes":["label"]},{label:w(()=>[k(g)[b.name].length?(V(),z("div",Ct,U(k(g)[b.name].map(_=>_.split("|")[1]).join(", ")),1)):j("",!0)]),option:w(({option:_})=>[y("span",Et,U(_.label||"-"),1)]),_:2},1032,["id","modelValue","onUpdate:modelValue","options"])]))),128)),n.filters.length%2===0?(V(),z("div",Ut)):j("",!0),y("div",It,[I(r,{variant:"solid",size:"2xs",color:"stone",onClick:s[3]||(s[3]=b=>u.value=[])},{default:w(()=>[O(U(n.t.reset),1)]),_:1})])])])]),default:w(()=>[I(r,{class:"text-stone-600",icon:"i-carbon/chevron-down",size:"md",color:"white",ui:{rounded:"rounded-l-none -ml-px"}})]),_:1},8,["open"])])):j("",!0)]),!k(f)&&n.filters.length?(V(),P(i,{key:0,modelValue:u.value,"onUpdate:modelValue":s[5]||(s[5]=l=>u.value=l),filters:n.filters},null,8,["modelValue","filters"])):j("",!0)],64)}}}),ie={database:{select:(...p)=>{},create:(...p)=>{},update:(...p)=>{},delete:(...p)=>{}},functions:{},can:p=>!0,support:(p,...u)=>!0};function me(p){return{data:oe([])}}const Mt={class:"flex min-h-[620px] flex-col p-4"},jt={class:"flex"},St={class:"flex flex-1 items-center gap-1"},Ot=["onClick"],Kt={key:0,class:"mx-1 text-stone-200"},Ft={class:"flex h-full flex-1 flex-col gap-4 p-4"},Pt={class:"mt-auto flex items-center justify-end gap-2 pt-5"},At=W({__name:"nx-crud-popup",props:se({options:{}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:["update:modelValue"],setup(p){const u=ae(p,"modelValue"),{data:d}=me(),m=K(p.options.tabs.flatMap(a=>a.components.filter(t=>t.component!=="none")));function v(){return p.options.tabs.reduce((a,t)=>(t.components.forEach(e=>{if(e.default==="now")return a[e.key]=new Date;if(e.default)return a[e.key]=e.default;a[e.key]={NxPickExcept:{mode:"PICK",list:[]}}[e.component??"UInput"]}),a),{})}const f=K(),g=K(v()),x=K(0);N([d,g],()=>{var e,i;(e=f.value)!=null&&e.getErrors().length&&f.value.validate((i=f.value)==null?void 0:i.getErrors().map("path")).catch(()=>null);const a=(l=[],b,_=C=>C)=>l.reduce((C,h)=>(C[h[b]]=_(h),C),{}),t=a(m.value,"key");m.value=m.value.map(l=>{var M;const[b,_,C]=((M=/([^:]*):([^(]*)\(?([^)]*)\)?/.exec(l.url))==null?void 0:M.slice(1))??[];if(b!=="specialty")return l;const h=C?C.split(","):[],E=d.value[0].commands[1].data[_];if(!E)return l;const c=h.reduce((F,S)=>{if(t[S].component==="NxPickExcept"){const Q=t[S].options;g.value[S].mode==="ALL"&&(F[S]=Q),g.value[S].mode==="PICK"&&(F[S]=g.value[S].list),g.value[S].mode==="EXCEPT"&&(F[S]=Q.filter(Z=>!g.value[S].list.includes(Z))),F[S]=a(F[S],"id",()=>!0)}return F},{});return l.options=E(C?c:null),l})},{deep:!0}),N(x,async(a,t)=>{var e;if(!(t>a))try{await((e=f.value)==null?void 0:e.validate(p.options.tabs.slice(t,a).flatMap(i=>i.components.map(l=>l.key))))}catch{s(f.value)}}),N(()=>$cfg.line,()=>{g.value=$cfg.line});async function n(a){const t=[];return p.options.tabs.flatMap(e=>e.components).forEach(e=>{e.required&&!a[e.key]&&t.push({path:e.key,message:"Required"}),e.component==="NxPickExcept"&&e.required&&a[e.key].mode==="PICK"&&!a[e.key].list.length&&t.push({path:e.key,message:"Required"})}),t}async function s(a){x.value=p.options.tabs.findIndex(t=>t.components.find(e=>e.key===a.errors[0].path)),de(()=>{const t=document.getElementById(a.errors[0].path);t==null||t.setAttribute("tabindex","0"),t==null||t.focus(),t==null||t.scrollIntoView({behavior:"smooth",block:"center"})})}async function r(a){console.log(a.data),g.value=v(),u.value=!1}function o(){g.value=v(),u.value=!1}return(a,t)=>{const e=J,i=je,l=Se,b=Oe;return V(),P(b,{modelValue:u.value,"onUpdate:modelValue":t[3]||(t[3]=_=>u.value=_)},{default:w(()=>[y("div",Mt,[y("div",jt,[y("div",St,[(V(!0),z(B,null,A(a.options.tabs,(_,C)=>(V(),z("div",{class:"flex items-center",key:`production-${C}`},[y("div",{class:X(["select-none text-sm font-medium",k(x)===C?"text-primary":"cursor-pointer text-stone-400 hover:text-stone-800"]),onClick:h=>x.value=C},U(_.name),11,Ot),C!==a.options.tabs.length-1?(V(),z("span",Kt,"/")):j("",!0)]))),128))]),I(e,{size:"md",color:"gray",variant:"ghost",icon:"i-carbon/close",class:"flex-none",onClick:t[0]||(t[0]=_=>o())})]),I(l,{state:k(g),validate:n,onError:s,onSubmit:r,ref_key:"form",ref:f},{default:w(()=>[y("div",Ft,[(V(!0),z(B,null,A(k(m).filter(_=>a.options.tabs[k(x)].components.find(C=>C.key===_.key)),_=>(V(),P(i,{id:_.key,name:_.key,label:_.key.format()},{default:w(()=>[(V(),P(Ve(_.component??"UInput"),le({modelValue:k(g)[_.key],"onUpdate:modelValue":C=>k(g)[_.key]=C,ref_for:!0},_),T({_:2},[A(Object.keys(a.$slots),C=>({name:C,fn:w(h=>[L(a.$slots,C,le({item:_,ref_for:!0},h))])}))]),1040,["modelValue","onUpdate:modelValue"]))]),_:2},1032,["id","name","label"]))),256)),y("div",Pt,[k(x)>0?(V(),P(e,{key:0,onClick:t[1]||(t[1]=_=>x.value--),variant:"ghost",size:"md",color:"stone",ui:{rounded:"rounded-full"}},{default:w(()=>[O(U(a.t.back),1)]),_:1})):j("",!0),k(x)<a.options.tabs.length-1?(V(),P(e,{key:1,onClick:t[2]||(t[2]=_=>x.value++),size:"md",ui:{rounded:"rounded-full"}},{default:w(()=>[O(U(a.t.next),1)]),_:1})):j("",!0),k(x)===a.options.tabs.length-1?(V(),P(e,{key:2,type:"submit",size:"md",ui:{rounded:"rounded-full"}},{default:w(()=>[O(U(a.t.confirm),1)]),_:1})):j("",!0)])])]),_:3},8,["state"])])]),_:3},8,["modelValue"])}}}),ee=new WeakMap;function ue(p,u,d={}){const{mode:m="replace",route:v=Ce(),router:f=Ee(),transform:g=o=>o}=d;ee.has(f)||ee.set(f,new Map);const x=ee.get(f);let n=v.query[p];Ue(()=>{n=void 0});let s;const r=Ie((o,a)=>(s=a,{get(){return o(),g(n!==void 0?n:H(u))},set(t){n!==t&&(n=t===u||t===null?void 0:t,x.set(p,t===u||t===null?void 0:t),a(),de(()=>{if(x.size===0)return;const e=Object.fromEntries(x.entries());x.clear();const{params:i,query:l,hash:b}=v;f[H(m)]({params:i,query:{...l,...e},hash:b})}))}}));return N(()=>v.query[p],o=>{n!==o&&(n=o,s())},{flush:"sync"}),r}function Nt(){const p=ue("tab","0",{transform:Number}),u=ue("filters"),d=K(Bt(u.value));return N(d,m=>u.value=Rt(m),{deep:!0}),{urlTab:p,urlFilters:d}}function Rt(p){let u="";return p.slice().sort().reduce((d,m)=>{const[v,f]=m.split("|");return u!==v&&(u=v,d+=(d?"||":"")+v),d+="|"+f,d},"")}function Bt(p){return p?p.split("||").flatMap(u=>{const[d,...m]=u.split("|");return m.map(v=>d+"|"+v)}):[]}function Dt({data:p,dimensions:u}){const d={data:p,dimensions:u,setup(){d.status=[];const{data:m,dimensions:v,status:f}=d;v.forEach((n,s)=>{n.mask=1<<s,n.map=n.map||(r=>r[n.name]),n.filter&&(n.breakdown={})});const g=v.filter(({filter:n})=>n),x=v.filter(({inc:n})=>n);m.forEach((n,s)=>(f[s]=0,g.forEach(({filter:r,breakdown:o,mask:a,map:t})=>{const e=t(n);if(o[e]||(o[e]=[]),o[e].push(s),r(e,n))return o[e].on=!0;o[e].on=!1,f[s]|=a}),f[s]===0?x.forEach(({inc:r})=>r(d,n)):g.forEach(({mask:r,inc:o})=>{!o||f[s]!==r||o(d,n)})))},filter(m,v){const{data:f,dimensions:g,status:x}=d,n=g.find(r=>r.name===m),s=g.filter(({name:r,inc:o})=>o&&n.name!==r);if(n.filter!==v){if(v?n.filter=v:delete n.filter,!n.breakdown)return n.breakdown={},f.forEach((r,o)=>{const a=n.map(r);if(n.breakdown[a]||(n.breakdown[a]=[]),n.breakdown[a].push(o),n.filter(a,r))return n.breakdown[a].on=!0;n.breakdown[a].on=!1,x[o]===0?s.forEach(({dec:t})=>t(d,f[o])):s.forEach(({mask:t,dec:e})=>{x[o]===t&&e(d,f[o])}),x[o]|=n.mask});v||(v=()=>!0),Object.entries(n.breakdown).forEach(([r,o])=>{const a=o.on;if(o.on=v(r),o.on!==a){if(o.on)return o.forEach(t=>{x[t]&=~n.mask,x[t]===0?s.forEach(({mask:e,inc:i})=>{if(n.mask!==e)return i(d,f[t])}):s.forEach(({mask:e,inc:i})=>{if(x[t]===e)return i(d,f[t])})});o.forEach(t=>{x[t]===0?s.forEach(({dec:e})=>e(d,f[t])):s.forEach(({mask:e,dec:i})=>{x[t]===e&&i(d,f[t])}),x[t]|=n.mask})}})}},clear(){d.dimensions.forEach(m=>d.filter(m.name))}};return d.setup(),d}function qt(p,u,d=[]){let m;const v=oe([]),f=oe([]);if(!d.length)return{xdata:p,xfilters:f};const g=d.map((n,s)=>{const r=n.key;return{key:r,name:r,inc:(o,a)=>{o.breakdown||(o.breakdown={}),o.breakdown[r]||(o.breakdown[r]={}),o.breakdown[r][a[r]]||(o.breakdown[r][a[r]]=0),o.breakdown[r][a[r]]++},dec:(o,a)=>{o.breakdown||(o.breakdown={}),o.breakdown[r]||(o.breakdown[r]={}),o.breakdown[r][a[r]]||(o.breakdown[r][a[r]]=0),o.breakdown[r][a[r]]--}}});function x(n,s){if(!s||!s.length)return m.filter(n,null);const r=s.reduce((o,a)=>(o[a]=!0,o),{undefined:!0});m.filter(n,o=>r[o])}return N(p,n=>m=Dt({data:n,dimensions:g}),{immediate:!0}),N(u,n=>{m.clear(),Object.entries(n).forEach(([s,r])=>x(s,r)),v.value=m.status.reduce((s,r,o)=>(!r&&s.push(m.data[o]),s),[]),f.value=Object.entries(m.breakdown??{}).map(([s,r])=>{const{sort:o,color:a,component:t}=d.find(l=>l.key===s)||{},e=Array.isArray(o)?[l=>-o.slice().reverse().indexOf(l.label),"-number"]:o||["-number","label"],i=Object.entries(r).filter(([l,b])=>!(l==="null"||l==="undefined")).map(([l,b])=>({id:`${s}|${l}`,filter:s,label:l.replace("undefined","-"),number:b,color:a==null?void 0:a[l]}));return{name:s,options:i.sort(e),component:t}})},{immediate:!0}),{xdata:v,xfilters:f}}const Tt={class:"flex items-center gap-2"},Lt={class:"flex items-center gap-2"},Wt=W({__name:"nx-crud-page",props:{options:{}},setup(p){const{data:u}=me(p.options.object),{urlTab:d,urlFilters:m}=Nt(),v=K([]),f=D(()=>{var e;if(v.value.length===0)return{};const t=m.value.reduce((i,l)=>{const[b,_]=l.split("|");return i[b]||(i[b]=[]),i[b].push(_),i},{});return(e=p.options.filters)==null||e.forEach(i=>{var _,C;if(t[i.key]||!i.select)return;const l={first:0,last:-1,tab:d.value}[i.select],b=(C=(_=v.value.find(h=>h.name===i.key))==null?void 0:_.options.at(l))==null?void 0:C.label;b&&(t[i.key]=Object.assign([b],{initial:!0,ignore:i.component==="none"}))}),t}),{xdata:g,xfilters:x}=qt(u,f,p.options.filters);v.value=x.value,N(f,()=>{const t=Object.entries(f.value).flatMap(([e,i])=>!i.initial||i.ignore?[]:i.map(l=>`${e}|${l}`));t.length!==0&&(m.value=m.value.concat(t))},{immediate:!0});const n=K(!1),s=D(()=>({object:p.options.object,...p.options.popup}));function r(t){return p.options.popup?{onImport:i=>l=>{const _=((C,h,E=c=>c)=>C.reduce((c,M)=>(c[M[h]]=E(M),c),{}))(p.options.popup.tabs.flatMap(C=>C.components),"label");l.forEach(C=>{const h=Object.entries(C).reduce((E,[c,M])=>{const F=_[c],S={datetime:R=>R.format("YYYY-MM-DD hh:mm:ss"),date:R=>R.format(),time:R=>R.format("hh:mm")},Q=F==null?void 0:F.type,Z=S[Q]??(R=>R),he=F?F.key:c,ve=Z(M);return E[he]=ve,E},{});if(!h.id)return ie.database.create(p.options.object,h);ie.database.update(p.options.object,h)})},...t}:t}async function o(t,e){$cfg.line=t.dataMap.list.find(i=>i.id===e.id)._data,n.value=!0}async function a(t){console.log("delete",t)}return(t,e)=>{const i=zt,l=At,b=J,_=Ke,C=Fe,h=Pe;return V(),P(h,null,{header:w(()=>[I(i,{modelValue:k(m),"onUpdate:modelValue":e[0]||(e[0]=E=>q(m)?m.value=E:null),filters:k(x).filter(E=>E.component!=="none")},null,8,["modelValue","filters"])]),default:w(()=>[t.options.grid?(V(),P(_,{key:0,class:"h-full min-h-[400px] rounded tabular-nums shadow",data:k(g),options:r(t.options.grid)},T({selected:w(({selection:E})=>[y("div",null,U(E),1)]),_:2},[A(Object.keys(t.$slots),E=>({name:E,fn:w(c=>[L(t.$slots,E,Y(G(c)))])})),t.options.popup?{name:"crud",fn:w(({state:E})=>[y("div",Tt,[I(l,{options:k(s),modelValue:k(n),"onUpdate:modelValue":e[1]||(e[1]=c=>q(n)?n.value=c:null)},T({_:2},[A(Object.keys(t.$slots),c=>({name:c,fn:w(M=>[L(t.$slots,c,Y(G(M)))])}))]),1032,["options","modelValue"]),I(b,{icon:"i-carbon/add",size:"2xs",color:"primary",variant:"solid",onClick:e[2]||(e[2]=c=>n.value=!0)},{default:w(()=>[O(U(t.t.create),1)]),_:1}),I(b,{icon:"i-carbon/trash-can",size:"2xs",color:"red",variant:"solid",onClick:c=>a(E.selection.items.list)},{default:w(()=>[O(U(t.t.delete),1)]),_:2},1032,["onClick"])])]),key:"0"}:void 0,t.options.popup?{name:"line-addon",fn:w(({state:E,item:c,isItemHover:M})=>[M?(V(),z("div",{key:0,class:"absolute top-0 z-50 flex h-7 -translate-x-full items-center px-2",style:ne({left:`${E.columns.headers.list[0].width+24}px`})},[I(b,{icon:"i-carbon/edit",size:"2xs",variant:"solid",tooltip:"edit",onClick:F=>o(E,c)},null,8,["onClick"])],4)):j("",!0)]),key:"1"}:void 0]),1032,["data","options"])):j("",!0),t.options.tabs?(V(),P(C,{key:1,items:t.options.tabs,modelValue:k(d),"onUpdate:modelValue":e[5]||(e[5]=E=>q(d)?d.value=E:null),unmount:!0},{item:w(({item:E})=>[I(_,{class:"h-full min-h-[400px] rounded rounded-tl-none tabular-nums shadow",data:k(g),options:r(E)},T({_:2},[A(Object.keys(t.$slots),c=>({name:c,fn:w(M=>[L(t.$slots,c,Y(G(M)))])})),t.options.popup?{name:"crud",fn:w(()=>[y("div",Lt,[I(l,{options:k(s),modelValue:k(n),"onUpdate:modelValue":e[3]||(e[3]=c=>q(n)?n.value=c:null)},T({_:2},[A(Object.keys(t.$slots),c=>({name:c,fn:w(M=>[L(t.$slots,c,Y(G(M)))])}))]),1032,["options","modelValue"]),t.options.popup?(V(),P(b,{key:0,icon:"i-carbon/add",size:"2xs",color:"primary",variant:"solid",onClick:e[4]||(e[4]=c=>n.value=!0)},{default:w(()=>[O(U(t.t.create),1)]),_:1})):j("",!0),I(b,{icon:"i-carbon/trash-can",size:"2xs",color:"red",variant:"solid"},{default:w(()=>[O(U(t.t.delete),1)]),_:1})])]),key:"0"}:void 0]),1032,["data","options"])]),_:3},8,["items","modelValue"])):j("",!0)]),_:3})}}}),sn=W({__name:"3-crud",setup(p){const u={object:"xyz",filters:[{key:"name"},{key:"status"}],grid:{columns:[{key:"name",label:"Name",type:"string",width:160},{key:"status",label:"Status",type:"boolean",width:60}],sortBy:["-Name"]}};return(d,m)=>{const v=Wt;return V(),P(v,{options:u})}}});export{sn as default};
