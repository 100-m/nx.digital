import{f as te,N as H,C as le,r as F,O as ae,o as E,c as O,a as x,F as T,q as P,t as U,b as M,i as g,z as L,w,d as K,v as Z,h as D,n as re,k as I,m as ne,K as fe,Q as ye,p as B,R as xe,S as ge,T as ee,U as ke,V as _e,g as we,E as N,j as $e,W as Ve,X as me,J as Ee,B as ie,Y,Z as Q,$ as Ce,a0 as je,a1 as Ue,a2 as Me,a3 as ue,a4 as J,a5 as G}from"./BPRHiPFR.js";import Oe from"./DbT-WjiX.js";import pe from"./By2t22F3.js";import Ie from"./DeI5MkbJ.js";import Se from"./7v3nTUlU.js";import ze from"./BayXnVkV.js";import Ke from"./CyOYk8dp.js";import{u as he,a as W}from"./5aBfFGo0.js";import{_ as Fe}from"./3i7_2xzH.js";import De from"./BFBR_-AK.js";import{_ as Pe}from"./CtvC2g-e.js";const Ne={class:"z-40 w-full max-w-full flex-none rounded bg-white px-3 py-2 shadow"},qe={class:"max-w-full @container"},Ae={class:"flex w-full flex-nowrap gap-x-3"},Be={class:"flex min-w-[150px] flex-1 flex-col gap-y-2"},Re=["for"],Te={class:"truncate"},Le={class:"mt-auto flex items-center"},We={for:"count",class:"cursor-pointer select-none px-2 font-medium"},Ye={class:"mb-1 flex items-center border-b border-stone-300 transition hover:bg-primary-100"},Qe=["for"],Xe=["id","name","indeterminate","checked","onInput"],Je={class:"truncate"},Ge={class:"flex flex-1 cursor-pointer select-none items-center gap-x-2 truncate text-sm leading-tight text-stone-800"},Ze={key:0,class:"ml-px text-2xs"},He={class:"truncate"},et={class:"flex flex-col"},tt=["for"],nt=["name","id","checked","onChange"],ot={key:0,class:"ml-px text-2xs"},st={class:"truncate"},at=10,ce=6,rt=40,lt=te({__name:"nx-crud-filter",props:H({filters:{}},{modelValue:{default:[]},modelModifiers:{}}),emits:["update:modelValue"],setup(p){const i=le(p,"modelValue"),m=F([]),v=F(!1);ae("filterChoices",m),ae("filterPercentage",v);const b=["hidden @[400px]:inline","hidden @[600px]:inline","hidden @[800px]:inline","hidden @[1000px]:inline","hidden @[1200px]:inline","hidden @[1400px]:inline","hidden @[1600px]:inline","hidden @[1800px]:inline","hidden @[2000px]:inline","hidden @[2200px]:inline"];function h(e,t){const o=e.map("number").max();return Math.round(t*rt/o)}function C(e,t){const o=e.sum("number");return Math.round(t/o*100)||0}function _(e){const t=i.value.filter(o=>!o.startsWith(e.name));if(n(e))return i.value=t;i.value=t.concat(e.options.map("id"))}function a(e,t){const o=i.value.findIndex(f=>f===e.id);o===-1?i.value.push(e.id):i.value.splice(o,1),setTimeout(()=>{t.target.checked=!!t.target.attributes.checked},0)}function s(e){return i.value.includes(e.id)}function c(e){const t=i.value.filter(o=>o.startsWith(e.name));return e.options.length!==t.length&&t.length>0}function n(e){const t=i.value.filter(o=>o.startsWith(e.name));return e.options.length===t.length}function d(e,t){const o=r(e);if(!o)return i.value=i.value.concat(t);const f=i.value.filter(y=>!y.startsWith(e.name));if(t===o)return i.value=f;i.value=f.concat(t)}function r(e){const t=i.value.find(o=>o.startsWith(e.name));if(t)return t}return(e,t)=>{const o=pe,f=Ie,y=ne,V=fe;return E(),O("div",Ne,[x("div",qe,[x("div",Ae,[x("div",Be,[(E(!0),O(T,null,P(e.filters.filter(l=>l.component==="single"),(l,k)=>(E(),O("div",null,[x("label",{for:"section-"+l.name,class:"flex flex-1 select-none items-center gap-x-2 truncate py-1 pl-1 font-medium"},[x("span",Te,U(l.name.format()),1)],8,Re),M(o,{searchable:"",id:"section-"+l.name,name:l.name,"model-value":r(l),onChange:u=>d(l,u),"value-attribute":"id","search-attributes":["label"],options:l.options},null,8,["id","name","model-value","onChange","options"])]))),256)),x("div",Le,[M(f,{id:"count",size:"md","on-icon":"i-carbon/percentage","off-icon":"i-carbon/character-whole-number",ui:{inactive:"bg-primary",active:"bg-primary",icon:{on:"text-stone-700",off:"text-stone-700"}},modelValue:g(v),"onUpdate:modelValue":t[0]||(t[0]=l=>L(v)?v.value=l:null)},null,8,["modelValue"]),x("label",We,U(g(v)?"Percent":"Count"),1),M(y,{class:"ml-auto",variant:"solid",size:"2xs",color:"stone",onClick:t[1]||(t[1]=l=>i.value=[])},{default:w(()=>[K(U(e.t.reset),1)]),_:1})])]),(E(!0),O(T,null,P(e.filters.filter(l=>!l.component).slice(0,at-1).map((l,k)=>e.filters.find(u=>u.name===g(m)[k])??l),(l,k)=>(E(),O("div",{class:Z(["min-w-[200px] flex-1",b[k]])},[x("div",Ye,[x("label",{for:"section-"+l.name,class:"flex flex-1 cursor-pointer select-none items-center gap-x-2 truncate py-1 pl-1 font-medium"},[x("input",{id:"section-"+l.name,name:l.name,indeterminate:c(l),checked:n(l),onInput:u=>_(l),type:"checkbox",class:"h-3.5 w-3.5 cursor-pointer rounded border-stone-400 text-primary focus:ring-1 focus:ring-primary"},null,40,Xe),x("span",Je,U(l.name.format()),1)],8,Qe),l.options.length>ce?(E(),D(V,{key:0,uiMenu:{width:"w-[200px] !-mr-6"},variant:"none",size:"2xs",modelValue:i.value,"onUpdate:modelValue":t[2]||(t[2]=u=>i.value=u),options:l.options,searchable:"",multiple:"","value-attribute":"id","search-attributes":["label"]},{option:w(({option:u})=>[x("label",Ge,[x("div",{class:Z(["h-[14px] min-w-[18px] truncate rounded-sm px-0.5 text-xs ordinal tabular-nums leading-[14px] text-white",u.color??"bg-primary"]),style:re(`width:${h(l.options,u.number)}px`)},[x("span",null,U(g(v)?C(l.options,u.number):u.number),1),g(v)?(E(),O("span",Ze,"%")):I("",!0)],6),x("span",He,U(u.label),1)])]),default:w(()=>[M(y,{size:"xs",color:"stone",variant:"link",class:"z-10 -mx-2 truncate"},{default:w(()=>[K(U(e.t.see_more),1)]),_:1})]),_:2},1032,["modelValue","options"])):I("",!0),M(V,{modelValue:g(m)[k]??l.name,options:e.filters.filter(u=>!u.component).map(u=>u.name),uiMenu:{width:"w-[200px]"},onChange:u=>g(m)[k]=g(m)[k]===u?null:u},{default:w(()=>[M(y,{icon:"i-carbon/chevron-down",size:"xs",color:"white",variant:"soft",class:"hover:text-primary-700"})]),_:2},1032,["modelValue","options","onChange"])]),x("ul",et,[(E(!0),O(T,null,P(l.options.slice(0,ce),u=>(E(),O("li",null,[x("label",{for:u.label,class:"flex flex-1 cursor-pointer select-none items-center gap-x-2 px-1 py-0.5 text-sm leading-tight text-stone-800 hover:bg-primary-100"},[x("input",{name:u.label,id:u.label,type:"checkbox",checked:s(u),onChange:j=>a(u,j),class:"h-3.5 w-3.5 flex-none cursor-pointer rounded border-stone-400 text-primary focus:ring-1 focus:ring-primary"},null,40,nt),x("div",{class:Z(["h-[14px] min-w-[18px] truncate rounded-sm px-0.5 text-xs ordinal tabular-nums leading-[14px] text-white",u.color??"bg-primary"]),style:re(`width:${h(l.options,u.number)}px`)},[x("span",null,U(g(v)?C(l.options,u.number):u.number),1),g(v)?(E(),O("span",ot,"%")):I("",!0)],6),x("span",st,U(u.label),1)],8,tt)]))),256))])],2))),256))])])])}}}),it=()=>{const p=B(()=>navigator&&navigator.userAgent&&navigator.userAgent.match(/Macintosh;/)),i=F(" "),m=xe(),v=B(()=>{var _,a,s;const b=(_=m.value)==null?void 0:_.tagName,h=(a=m.value)==null?void 0:a.contentEditable;return b==="INPUT"||b==="TEXTAREA"||h==="true"||h==="plaintext-only"?((s=m.value)==null?void 0:s.name)||!0:!1});return ge(()=>{i.value=p.value?"âŒ˜":"Ctrl"}),{macOS:p,metaSymbol:i,activeElement:m,usingInput:v}},be=ye(it);function ut(...p){return B(()=>p.every(i=>ee(i)))}function ct(p){return B(()=>!ee(p))}const dt=/^[^-]+.*-.*[^-]+$/,ft=/^[^_]+.*_.*[^_]+$/,mt=(p,i={})=>{const{macOS:m,usingInput:v}=be();let b=[];const h=F([]),C=()=>{h.value.splice(0,h.value.length)},_=ke(C,i.chainDelay??800),a=s=>{if(!s.key)return;const c=/^[a-z]{1}$/i.test(s.key);let n;if(h.value.push(s.key),h.value.length>=2){n=h.value.slice(-2).join("-");for(const d of b.filter(r=>r.chained))if(d.key===n){d.condition.value&&(s.preventDefault(),d.handler()),C();return}}for(const d of b.filter(r=>!r.chained))if(s.key.toLowerCase()===d.key&&s.metaKey===d.metaKey&&s.ctrlKey===d.ctrlKey&&!(c&&s.shiftKey!==d.shiftKey)){d.condition.value&&(s.preventDefault(),d.handler()),C();return}_()};b=Object.entries(p).map(([s,c])=>{var e,t;if(!c)return null;let n;s.includes("-")&&s!=="-"&&!((e=s.match(dt))!=null&&e.length)&&console.trace(`[Shortcut] Invalid key: "${s}"`),s.includes("_")&&s!=="_"&&!((t=s.match(ft))!=null&&t.length)&&console.trace(`[Shortcut] Invalid key: "${s}"`);const d=s.includes("-")&&s!=="-";if(d)n={key:s.toLowerCase(),metaKey:!1,ctrlKey:!1,shiftKey:!1,altKey:!1};else{const o=s.toLowerCase().split("_").map(f=>f);n={key:o.filter(f=>!["meta","ctrl","shift","alt"].includes(f)).join("_"),metaKey:o.includes("meta"),ctrlKey:o.includes("ctrl"),shiftKey:o.includes("shift"),altKey:o.includes("alt")}}if(n.chained=d,!m.value&&n.metaKey&&!n.ctrlKey&&(n.metaKey=!1,n.ctrlKey=!0),typeof c=="function"?n.handler=c:typeof c=="object"&&(n={...n,handler:c.handler}),!n.handler)return console.trace("[Shortcut] Invalid value"),null;const r=[];return c.usingInput?typeof c.usingInput=="string"&&r.push(B(()=>v.value===c.usingInput)):r.push(ct(v)),n.condition=ut(...r,...c.whenever||[]),n}).filter(Boolean),_e("keydown",a)},pt={class:"flex flex-none flex-col items-center justify-between gap-3 md:flex-row"},ht={class:"flex flex-col"},bt={class:"truncate text-3xl font-black"},vt={class:"-mb-2 text-lg/tight text-stone-700"},yt={key:0,class:"flex md:w-[320px] lg:w-1/2"},xt={key:0,class:"flex w-full items-center pr-4"},gt={class:"mr-auto truncate"},kt={key:1},_t={class:"truncate"},wt={class:"flex items-center gap-0.5"},$t={class:"rounded border border-stone-300 bg-white px-4 py-3 shadow @container"},Vt={class:"grid grid-cols-1 gap-1 @[400px]:grid-cols-2"},Et=["for"],Ct={key:0,class:"truncate"},jt={class:"truncate"},Ut={key:0,class:"h-7"},Mt={class:"m-auto mr-0 flex gap-x-2"},Ot=te({__name:"nx-crud-filters",props:H({filters:{}},{modelValue:{default:[]},modelModifiers:{}}),emits:["update:modelValue"],setup(p){const i=le(p,"modelValue"),m=p,{page:v}=we(),b=F(!1),h=F(!1);ae("retractFilter",h);const C=F({}),_=B(()=>m.filters.reduce((s,c)=>(c.options.forEach(n=>s[n.id]=n),s),{}));N(C,()=>{const s=Object.values(C.value).flat();Object.equal(s,i.value)||(i.value=s)},{deep:!0}),N([i,m],()=>{const s=m.filters.reduce((n,d)=>(n[d.name]=[],n),{}),c=i.value.reduce((n,d)=>{const[r,e]=d.split("|");return n[r]||(n[r]=[]),n[r].push(d),n},s);C.value=c},{immediate:!0});const{metaSymbol:a}=be();return mt({meta_k:{usingInput:!0,handler:()=>$("#search").click()},escape:{usingInput:!0,whenever:[b],handler:()=>b.value=!1}}),(s,c)=>{const n=ne,d=Oe,r=pe,e=fe,t=Ve,o=lt;return E(),O(T,null,[x("div",pt,[x("div",ht,[x("h1",bt,U(s.t[g(v).meta.title+"_title"]),1),x("h2",vt,U(s.t[g(v).meta.title+"_subtitle"]),1)]),s.filters.length?(E(),O("div",yt,[M(n,{class:"text-stone-600",size:"md",color:"white",icon:g(h)?"i-carbon/filter-remove":"i-carbon/filter",ui:{rounded:"rounded-r-none -mr-px"},tooltip:g(h)?s.t.show_filter:s.t.hide_filter,onClick:c[0]||(c[0]=f=>h.value=!g(h))},null,8,["icon","tooltip"]),M(r,{id:"search",name:"search",class:"w-[calc(100%-80px)]",ui:{rounded:"rounded-none z-10"},icon:"i-carbon/search",size:"lg",searchable:"",multiple:"",placeholder:s.t.search,modelValue:i.value,"onUpdate:modelValue":c[2]||(c[2]=f=>i.value=f),"value-attribute":"id","search-attributes":["filter","key","label"],options:s.filters.flatMap(f=>f.options)},{label:w(()=>[i.value.length?(E(),O("div",xt,[x("div",gt,U(i.value.map(f=>{var y;return(y=g(_)[f])==null?void 0:y.label}).join(", ")),1),M(n,{class:"-my-1 mx-1",variant:"solid",size:"2xs",color:"stone",onClick:c[1]||(c[1]=$e(f=>i.value=[],["stop"]))},{default:w(()=>[K(U(s.t.reset),1)]),_:1})])):(E(),O("span",kt,"Add filter"))]),option:w(({option:f})=>[x("span",_t,[x("b",null,U(f.filter),1),K(" | "+U(f.label||"-"),1)])]),trailing:w(()=>[x("div",wt,[M(d,null,{default:w(()=>[K(U(g(a)),1)]),_:1}),M(d,null,{default:w(()=>c[6]||(c[6]=[K("K")])),_:1})])]),_:1},8,["placeholder","modelValue","options"]),M(t,{open:g(b),"onUpdate:open":c[4]||(c[4]=f=>L(b)?b.value=f:null),popper:{placement:"bottom-end"},ui:{container:"w-2/3 lg:w-1/2 mr-1"}},{panel:w(({close:f})=>[x("div",$t,[x("div",Vt,[(E(!0),O(T,null,P(s.filters,y=>(E(),O("div",{class:"grid grid-cols-[35%_65%] gap-x-2",key:y.name},[x("label",{for:y.name,class:"place-self-end self-center text-right text-sm font-medium"},U(y.name.format()),9,Et),M(e,{uiMenu:{width:"max-w-[300px] w-full",popper:{strategy:"fixed"}},id:y.name,searchable:"",multiple:"",modelValue:g(C)[y.name],"onUpdate:modelValue":V=>g(C)[y.name]=V,options:y.options,"value-attribute":"id","search-attributes":["key","label"]},{label:w(()=>[g(C)[y.name].length?(E(),O("div",Ct,U(g(C)[y.name].map(V=>{var l;return(l=g(_)[V])==null?void 0:l.label}).join(", ")),1)):I("",!0)]),option:w(({option:V})=>[x("span",jt,U(V.label||"-"),1)]),_:2},1032,["id","modelValue","onUpdate:modelValue","options"])]))),128)),s.filters.length%2===0?(E(),O("div",Ut)):I("",!0),x("div",Mt,[M(n,{variant:"solid",size:"2xs",color:"stone",onClick:c[3]||(c[3]=y=>i.value=[])},{default:w(()=>[K(U(s.t.reset),1)]),_:1})])])])]),default:w(()=>[M(n,{class:"text-stone-600",icon:"i-carbon/chevron-down",size:"md",color:"white",ui:{rounded:"rounded-l-none -ml-px"}})]),_:1},8,["open"])])):I("",!0)]),!g(h)&&s.filters.length?(E(),D(o,{key:0,modelValue:i.value,"onUpdate:modelValue":c[5]||(c[5]=f=>i.value=f),filters:s.filters},null,8,["modelValue","filters"])):I("",!0)],64)}}}),It={class:"flex min-h-[620px] flex-col p-4"},St={class:"flex"},zt={class:"flex flex-1 items-center gap-1"},Kt=["onClick"],Ft={key:0,class:"mx-1 text-stone-200"},Dt={class:"flex h-full flex-1 flex-col gap-4 p-4"},Pt={class:"mt-auto flex items-center justify-end gap-2 pt-5"},Nt=te({__name:"nx-crud-popup",props:H({options:{}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:H(["submit"],["update:modelValue"]),setup(p,{emit:i}){const m=le(p,"modelValue"),v=i,{data:b}=he("specialties"),h=F(p.options.tabs.flatMap(e=>e.components.filter(t=>t.component!=="none")));function C(){return p.options.tabs.reduce((e,t)=>(t.components.forEach(o=>{if(o.default==="now")return e[o.key]=new Date;if(o.default)return e[o.key]=o.default;e[o.key]={NxPickExcept:{mode:"PICK",list:[]}}[o.component??"UInput"]}),e),{})}const _=F(),a=F(C()),s=F(0);N([b,a],()=>{var o,f;(o=_.value)!=null&&o.getErrors().length&&_.value.validate((f=_.value)==null?void 0:f.getErrors().map("path")).catch(()=>null);const e=(y=[],V,l=k=>k)=>y.reduce((k,u)=>(k[u[V]]=l(u),k),{}),t=e(h.value,"key");h.value=h.value.map(y=>{var q;const[V,l,k]=((q=/([^:]*):([^(]*)\(?([^)]*)\)?/.exec(y.url))==null?void 0:q.slice(1))??[];if(V!=="specialty")return y;const u=k?k.split(","):[],j=b.value[0].datapoints[l];if(!j)return y;const S=u.reduce((A,z)=>{if(t[z].component==="NxPickExcept"){const X=t[z].options;a.value[z].mode==="ALL"&&(A[z]=X),a.value[z].mode==="PICK"&&(A[z]=a.value[z].list),a.value[z].mode==="EXCEPT"&&(A[z]=X.filter(oe=>!a.value[z].list.includes(oe))),A[z]=e(A[z],"id",()=>!0)}return A},{});return y.options=j(k?S:null),y})},{deep:!0}),N(s,async(e,t)=>{var o;if(!(t>e))try{await((o=_.value)==null?void 0:o.validate(p.options.tabs.slice(t,e).flatMap(f=>f.components.map(y=>y.key))))}catch{n(_.value)}}),N(()=>$cfg.line,()=>{a.value=$cfg.line});async function c(e){const t=[];return p.options.tabs.flatMap(o=>o.components).forEach(o=>{o.required&&!e[o.key]&&t.push({path:o.key,message:"Required"}),o.component==="NxPickExcept"&&o.required&&e[o.key].mode==="PICK"&&!e[o.key].list.length&&t.push({path:o.key,message:"Required"})}),t}async function n(e){s.value=p.options.tabs.findIndex(t=>t.components.find(o=>o.key===e.errors[0].path)),me(()=>{const t=document.getElementById(e.errors[0].path);t==null||t.setAttribute("tabindex","0"),t==null||t.focus(),t==null||t.scrollIntoView({behavior:"smooth",block:"center"})})}async function d(e){v("submit",e.data),a.value=C(),m.value=!1}function r(){a.value=C(),m.value=!1}return(e,t)=>{const o=ne,f=Se,y=ze,V=Ke;return E(),D(V,{modelValue:m.value,"onUpdate:modelValue":t[3]||(t[3]=l=>m.value=l)},{default:w(()=>[x("div",It,[x("div",St,[x("div",zt,[(E(!0),O(T,null,P(e.options.tabs,(l,k)=>(E(),O("div",{class:"flex items-center",key:`production-${k}`},[x("div",{class:Z(["select-none text-sm font-medium",g(s)===k?"text-primary":"cursor-pointer text-stone-400 hover:text-stone-800"]),onClick:u=>s.value=k},U(l.name),11,Kt),k!==e.options.tabs.length-1?(E(),O("span",Ft,"/")):I("",!0)]))),128))]),M(o,{size:"md",color:"gray",variant:"ghost",icon:"i-carbon/close",class:"flex-none",onClick:t[0]||(t[0]=l=>r())})]),M(y,{state:g(a),validate:c,onError:n,onSubmit:d,ref_key:"form",ref:_},{default:w(()=>[x("div",Dt,[(E(!0),O(T,null,P(g(h).filter(l=>e.options.tabs[g(s)].components.find(k=>k.key===l.key)),l=>(E(),D(f,{id:l.key,name:l.key,label:l.key.format()},{default:w(()=>[(E(),D(Ee(l.component??"UInput"),ie({modelValue:g(a)[l.key],"onUpdate:modelValue":k=>g(a)[l.key]=k,ref_for:!0},l),Y({_:2},[P(Object.keys(e.$slots),k=>({name:k,fn:w(u=>[Q(e.$slots,k,ie({item:l,ref_for:!0},u))])}))]),1040,["modelValue","onUpdate:modelValue"]))]),_:2},1032,["id","name","label"]))),256)),x("div",Pt,[g(s)>0?(E(),D(o,{key:0,onClick:t[1]||(t[1]=l=>s.value--),variant:"ghost",size:"md",color:"stone",ui:{rounded:"rounded-full"}},{default:w(()=>[K(U(e.t.back),1)]),_:1})):I("",!0),g(s)<e.options.tabs.length-1?(E(),D(o,{key:1,onClick:t[2]||(t[2]=l=>s.value++),size:"md",ui:{rounded:"rounded-full"}},{default:w(()=>[K(U(e.t.next),1)]),_:1})):I("",!0),g(s)===e.options.tabs.length-1?(E(),D(o,{key:2,type:"submit",size:"md",ui:{rounded:"rounded-full"}},{default:w(()=>[K(U(e.t.confirm),1)]),_:1})):I("",!0)])])]),_:3},8,["state"])])]),_:3},8,["modelValue"])}}}),se=new WeakMap;function de(p,i,m={}){const{mode:v="replace",route:b=Ce(),router:h=je(),transform:C=n=>n}=m;se.has(h)||se.set(h,new Map);const _=se.get(h);let a=b.query[p];Me(()=>{a=void 0});let s;const c=Ue((n,d)=>(s=d,{get(){return n(),C(a!==void 0?a:ee(i))},set(r){a!==r&&(a=r===i||r===null?void 0:r,_.set(p,r===i||r===null?void 0:r),d(),me(()=>{if(_.size===0)return;const e=Object.fromEntries(_.entries());_.clear();const{params:t,query:o,hash:f}=b;h[ee(v)]({params:t,query:{...o,...e},hash:f})}))}}));return N(()=>b.query[p],n=>{a!==n&&(a=n,s())},{flush:"sync"}),c}function qt(){const p=de("tab","0",{transform:Number}),i=de("filters"),m=F(Bt(i.value));return N(m,v=>i.value=At(v),{deep:!0}),{urlTab:p,urlFilters:m}}function At(p){let i="";return p.slice().sort().reduce((m,v)=>{const[b,h]=v.split("|");return i!==b&&(i=b,m+=(m?"||":"")+b),m+="|"+h,m},"")}function Bt(p){return p?p.split("||").flatMap(i=>{const[m,...v]=i.split("|");return v.map(b=>m+"|"+b)}):[]}function Rt({data:p,dimensions:i}){const m={data:p,dimensions:i,setup(){m.status=[];const{data:v,dimensions:b,status:h}=m;b.forEach((a,s)=>{a.mask=1<<s,a.map=a.map||(c=>c[a.name]),a.filter&&(a.breakdown={})});const C=b.filter(({filter:a})=>a),_=b.filter(({inc:a})=>a);v.forEach((a,s)=>(h[s]=0,C.forEach(({filter:c,breakdown:n,mask:d,map:r})=>{const e=r(a);if(n[e]||(n[e]=[]),n[e].push(s),c(e,a))return n[e].on=!0;n[e].on=!1,h[s]|=d}),h[s]===0?_.forEach(({inc:c})=>c(m,a)):C.forEach(({mask:c,inc:n})=>{!n||h[s]!==c||n(m,a)})))},filter(v,b){const{data:h,dimensions:C,status:_}=m,a=C.find(c=>c.name===v),s=C.filter(({name:c,inc:n})=>n&&a.name!==c);if(a.filter!==b){if(b?a.filter=b:delete a.filter,!a.breakdown)return a.breakdown={},h.forEach((c,n)=>{const d=a.map(c);if(a.breakdown[d]||(a.breakdown[d]=[]),a.breakdown[d].push(n),a.filter(d,c))return a.breakdown[d].on=!0;a.breakdown[d].on=!1,_[n]===0?s.forEach(({dec:r})=>r(m,h[n])):s.forEach(({mask:r,dec:e})=>{_[n]===r&&e(m,h[n])}),_[n]|=a.mask});b||(b=()=>!0),Object.entries(a.breakdown).forEach(([c,n])=>{const d=n.on;if(n.on=b(c),n.on!==d){if(n.on)return n.forEach(r=>{_[r]&=~a.mask,_[r]===0?s.forEach(({mask:e,inc:t})=>{if(a.mask!==e)return t(m,h[r])}):s.forEach(({mask:e,inc:t})=>{if(_[r]===e)return t(m,h[r])})});n.forEach(r=>{_[r]===0?s.forEach(({dec:e})=>e(m,h[r])):s.forEach(({mask:e,dec:t})=>{_[r]===e&&t(m,h[r])}),_[r]|=a.mask})}})}},clear(){m.dimensions.forEach(v=>m.filter(v.name))}};return m.setup(),m}function Tt(p,i,m=[]){let v;const b=ue([]),h=ue([]);if(!m.length)return{xdata:p,xfilters:h};const C=m.map((n,d)=>{const r=n.key;return{key:r,name:r,inc:(e,t)=>{e.breakdown||(e.breakdown={}),e.breakdown[r]||(e.breakdown[r]={}),e.breakdown[r][t[r]]||(e.breakdown[r][t[r]]=0),e.breakdown[r][t[r]]++},dec:(e,t)=>{e.breakdown||(e.breakdown={}),e.breakdown[r]||(e.breakdown[r]={}),e.breakdown[r][t[r]]||(e.breakdown[r][t[r]]=0),e.breakdown[r][t[r]]--}}});return N(p,_,{immediate:!0}),N(i,s,{immediate:!0}),{xdata:b,xfilters:h};function _(){v=Rt({data:p.value,dimensions:C}),s()}function a(n,d){if(!d||!d.length)return v.filter(n,null);const r=d.reduce((e,t)=>(e[t]=!0,e),{undefined:!0});v.filter(n,e=>r[e])}function s(){v.clear(),Object.entries(i.value).forEach(([n,d])=>a(n,d)),b.value=v.status.reduce((n,d,r)=>(!d&&n.push(v.data[r]),n),[]),h.value=Object.entries(v.breakdown??{}).map(([n,d])=>{const{sort:r,color:e,component:t,type:o}=m.find(V=>V.key===n)||{},f=Array.isArray(r)?[V=>-r.slice().reverse().indexOf(V.label),"-number"]:r||["-number","label"],y=Object.entries(d).filter(([V,l])=>!(V==="null"||V==="undefined")).map(([V,l])=>{const k=V.replace("undefined","-");return{id:`${n}|${V}`,filter:n,key:k,label:c(k,o),number:l,color:e==null?void 0:e[V]}});return{name:n,options:y.sort(f),component:t}})}function c(n,d){return d==="number"?(+n).format($ctx.lang):d==="datetime"?new Date(n).format("year, month, day, hour, minute, second",$ctx.lang):d==="date"?new Date(n).format("year, month, day",$ctx.lang):d==="time"?new Date(n).format("hour, minute, second",$ctx.lang):n}}const Lt={class:"flex items-center gap-2"},Wt={class:"flex items-center gap-2"},sn=te({__name:"nx-crud-page",props:{options:{}},setup(p){const{data:i}=he(p.options.object),m=B(()=>p.options.translations?i.value.map(e=>Object.entries(p.options.translations).reduce((t,[o,f])=>(t[f]=window.access(e,o)??"-",t),e)):i.value),{urlTab:v,urlFilters:b}=qt(),h=F({}),{xdata:C,xfilters:_}=Tt(m,h,p.options.filters);N(()=>{var t;const e=b.value.reduce((o,f)=>{const[y,V]=f.split("|");return o[y]||(o[y]=[]),o[y].push(V),o},{});return(t=p.options.filters)==null||t.forEach(o=>{var V,l;if(e[o.key]||!o.select)return;const f={first:0,last:-1,tab:v.value}[o.select],y=(l=(V=_.value.find(k=>k.name===o.key))==null?void 0:V.options.at(f))==null?void 0:l.key;y&&(e[o.key]=Object.assign([y],{initial:!0,ignore:o.component==="none"}))}),e},e=>{if(JSON.stringify(e)===JSON.stringify(h.value))return;h.value=e;const t=Object.entries(h.value).flatMap(([o,f])=>!f.initial||f.ignore?[]:f.map(y=>`${o}|${y}`));t.length!==0&&(b.value=b.value.concat(t))},{immediate:!0});const a=F(!1),s=B(()=>({object:p.options.object,...p.options.popup}));function c(e){return p.options.popup?{onImport:o=>f=>{const V=((l,k,u=j=>j)=>l.reduce((j,S)=>(j[S[k]]=u(S),j),{}))(p.options.popup.tabs.flatMap(l=>l.components),"label");f.forEach(l=>{const k=Object.entries(l).reduce((u,[j,S])=>{const q=V[j],A={datetime:R=>R.format("YYYY-MM-DD hh:mm:ss"),date:R=>R.format(),time:R=>R.format("hh:mm")},z=q==null?void 0:q.type,X=A[z]??(R=>R),oe=q?q.key:j,ve=X(S);return u[oe]=ve,u},{});if(!k.id)return W.database.create(p.options.object,k);W.database.update(p.options.object,k)})},...e}:e}async function n(e,t){$cfg.line={...e.dataMap.list.find(o=>o.id===t.id)._data},a.value=!0}async function d(e){if(Object.entries(p.options.translations||{}).forEach(([t,o])=>{e[t]=e[o],delete e[o]}),e.id==null)return W.database.create(p.options.object,e);W.database.update(p.options.object,e)}async function r(e){e.forEach(t=>W.database.delete(p.options.object,t))}return(e,t)=>{const o=Ot,f=ne,y=Nt,V=Fe,l=De,k=Pe;return E(),D(k,null,{header:w(()=>[M(o,{modelValue:g(b),"onUpdate:modelValue":t[0]||(t[0]=u=>L(b)?b.value=u:null),filters:g(_).filter(u=>u.component!=="none")},null,8,["modelValue","filters"])]),default:w(()=>[e.options.grid?(E(),D(V,{key:0,class:"h-full min-h-[400px] rounded tabular-nums shadow",data:g(C),options:c(e.options.grid)},Y({_:2},[e.options.popup?{name:"line-addon",fn:w(({state:u,item:j,isItemHover:S})=>[S?(E(),O("div",{key:0,class:"absolute top-0 z-50 flex h-7 -translate-x-full items-center px-2",style:re({left:`${u.columns.headers.list[0].width+24}px`})},[M(f,{icon:"i-carbon/edit",size:"2xs",variant:"solid",tooltip:"edit",onClick:q=>n(u,j)},null,8,["onClick"])],4)):I("",!0)]),key:"0"}:void 0,P(Object.keys(e.$slots),u=>({name:u,fn:w(j=>[Q(e.$slots,u,J(G(j)))])})),e.options.popup?{name:"crud",fn:w(({state:u})=>[x("div",Lt,[M(y,{options:g(s),modelValue:g(a),"onUpdate:modelValue":t[1]||(t[1]=j=>L(a)?a.value=j:null),onSubmit:d},Y({_:2},[P(Object.keys(e.$slots),j=>({name:j,fn:w(S=>[Q(e.$slots,j,J(G(S)))])}))]),1032,["options","modelValue"]),M(f,{icon:"i-carbon/add",size:"2xs",color:"primary",variant:"solid",onClick:t[2]||(t[2]=j=>a.value=!0)},{default:w(()=>[K(U(e.t.create),1)]),_:1}),M(f,{icon:"i-carbon/trash-can",size:"2xs",color:"red",variant:"solid",onClick:j=>r(u.selection.items.list)},{default:w(()=>[K(U(e.t.delete),1)]),_:2},1032,["onClick"])])]),key:"1"}:void 0]),1032,["data","options"])):I("",!0),e.options.tabs?(E(),D(l,{key:1,items:e.options.tabs,modelValue:g(v),"onUpdate:modelValue":t[5]||(t[5]=u=>L(v)?v.value=u:null),unmount:!0},{item:w(({item:u})=>[M(V,{class:"h-full min-h-[400px] rounded rounded-tl-none tabular-nums shadow",data:g(C),options:c(u)},Y({_:2},[P(Object.keys(e.$slots),j=>({name:j,fn:w(S=>[Q(e.$slots,j,J(G(S)))])})),e.options.popup?{name:"crud",fn:w(()=>[x("div",Wt,[M(y,{options:g(s),modelValue:g(a),"onUpdate:modelValue":t[3]||(t[3]=j=>L(a)?a.value=j:null)},Y({_:2},[P(Object.keys(e.$slots),j=>({name:j,fn:w(S=>[Q(e.$slots,j,J(G(S)))])}))]),1032,["options","modelValue"]),e.options.popup?(E(),D(f,{key:0,icon:"i-carbon/add",size:"2xs",color:"primary",variant:"solid",onClick:t[4]||(t[4]=j=>a.value=!0)},{default:w(()=>[K(U(e.t.create),1)]),_:1})):I("",!0),M(f,{icon:"i-carbon/trash-can",size:"2xs",color:"red",variant:"solid"},{default:w(()=>[K(U(e.t.delete),1)]),_:1})])]),key:"0"}:void 0]),1032,["data","options"])]),_:3},8,["items","modelValue"])):I("",!0)]),_:3})}}});export{sn as _};
