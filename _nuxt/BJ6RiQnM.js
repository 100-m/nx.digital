import{f as G,M as se,B as ae,r as K,N as ne,o as E,c as j,a as x,F as D,q as A,t as U,b as I,i as k,y as R,w,d as z,s as X,h as P,n as oe,k as O,m as Z,J as ce,O as be,p as B,Q as ye,R as xe,S as J,T as _e,U as ge,g as ke,D as N,j as we,V as $e,W as de,I as Ve,A as le,X as T,Y as L,Z as Ee,$ as Ce,a0 as Ue,a1 as Ie,a2 as re,a3 as Y,a4 as Q}from"./BJUyEi7U.js";import je from"./BfLXlB0J.js";import pe from"./DumxBdTx.js";import Me from"./CpOOptx6.js";import Oe from"./Bn563bbm.js";import Se from"./BPIFlLz2.js";import ze from"./DAt-5rPa.js";import{u as fe,a as ee}from"./CUvU4tPK.js";import{_ as Ke}from"./B_6uN8ho.js";import Fe from"./BR-gcGXH.js";import{_ as Pe}from"./CiweJmm9.js";const Ae={class:"z-40 w-full max-w-full flex-none rounded bg-white px-3 py-2 shadow"},Ne={class:"max-w-full @container"},qe={class:"flex w-full flex-nowrap gap-x-3"},De={class:"flex min-w-[150px] flex-1 flex-col gap-y-2"},Be=["for"],Re={class:"truncate"},Te={class:"mt-auto flex items-center"},Le={for:"count",class:"cursor-pointer select-none px-2 font-medium"},We={class:"mb-1 flex items-center border-b border-stone-300 transition hover:bg-primary-100"},Ye=["for"],Qe=["id","name","indeterminate","checked","onInput"],Xe={class:"truncate"},Je={class:"flex flex-1 cursor-pointer select-none items-center gap-x-2 truncate text-sm leading-tight text-stone-800"},Ge={key:0,class:"ml-px text-2xs"},Ze={class:"truncate"},He={class:"flex flex-col"},et=["for"],tt=["name","id","checked","onChange"],nt={key:0,class:"ml-px text-2xs"},ot={class:"truncate"},st=10,ie=6,at=40,lt=G({__name:"nx-crud-filter",props:se({filters:{}},{modelValue:{default:[]},modelModifiers:{}}),emits:["update:modelValue"],setup(m){const u=ae(m,"modelValue"),f=K([]),b=K(!1);ne("filterChoices",f),ne("filterPercentage",b);function h(t,a){const l=t.map("number").max();return Math.round(a*at/l)}function p(t,a){const l=t.sum("number");return Math.round(a/l*100)||0}function g(t){const a=u.value.filter(l=>!l.startsWith(t.name));if(i(t))return u.value=a;u.value=a.concat(t.options.map("id"))}function _(t,a){const l=u.value.findIndex(d=>d===t.id);l===-1?u.value.push(t.id):u.value.splice(l,1),setTimeout(()=>{a.target.checked=!!a.target.attributes.checked},0)}function o(t){return u.value.includes(t.id)}function r(t){const a=u.value.filter(l=>l.startsWith(t.name));return t.options.length!==a.length&&a.length>0}function i(t){const a=u.value.filter(l=>l.startsWith(t.name));return t.options.length===a.length}function s(t,a){const l=n(t);if(!l)return u.value=u.value.concat(a);const d=u.value.filter(y=>!y.startsWith(t.name));if(a===l)return u.value=d;u.value=d.concat(a)}function n(t){const a=u.value.find(l=>l.startsWith(t.name));if(a)return a}const e=["hidden @[400px]:inline","hidden @[600px]:inline","hidden @[800px]:inline","hidden @[1000px]:inline","hidden @[1200px]:inline","hidden @[1400px]:inline","hidden @[1600px]:inline","hidden @[1800px]:inline","hidden @[2000px]:inline","hidden @[2200px]:inline"];return(t,a)=>{const l=pe,d=Me,y=Z,V=ce;return E(),j("div",Ae,[x("div",Ne,[x("div",qe,[x("div",De,[(E(!0),j(D,null,A(t.filters.filter(v=>v.component==="single"),(v,C)=>(E(),j("div",null,[x("label",{for:"section-"+v.name,class:"flex flex-1 select-none items-center gap-x-2 truncate py-1 pl-1 font-medium"},[x("span",Re,U(v.name.format()),1)],8,Be),I(l,{searchable:"",id:"section-"+v.name,name:v.name,"model-value":n(v),onChange:c=>s(v,c),"value-attribute":"id","search-attributes":["label"],options:v.options},null,8,["id","name","model-value","onChange","options"])]))),256)),x("div",Te,[I(d,{id:"count",size:"md","on-icon":"i-carbon/percentage","off-icon":"i-carbon/character-whole-number",ui:{inactive:"bg-primary",active:"bg-primary",icon:{on:"text-stone-700",off:"text-stone-700"}},modelValue:k(b),"onUpdate:modelValue":a[0]||(a[0]=v=>R(b)?b.value=v:null)},null,8,["modelValue"]),x("label",Le,U(k(b)?"Percent":"Count"),1),I(y,{class:"ml-auto",variant:"solid",size:"2xs",color:"stone",onClick:a[1]||(a[1]=v=>u.value=[])},{default:w(()=>[z(U(t.t.reset),1)]),_:1})])]),(E(!0),j(D,null,A(t.filters.filter(v=>!v.component).slice(0,st-1).map((v,C)=>t.filters.find(c=>c.name===k(f)[C])??v),(v,C)=>(E(),j("div",{class:X(["min-w-[200px] flex-1",e[C]])},[x("div",We,[x("label",{for:"section-"+v.name,class:"flex flex-1 cursor-pointer select-none items-center gap-x-2 truncate py-1 pl-1 font-medium"},[x("input",{id:"section-"+v.name,name:v.name,indeterminate:r(v),checked:i(v),onInput:c=>g(v),type:"checkbox",class:"h-3.5 w-3.5 cursor-pointer rounded border-stone-400 text-primary focus:ring-1 focus:ring-primary"},null,40,Qe),x("span",Xe,U(v.name.format()),1)],8,Ye),v.options.length>ie?(E(),P(V,{key:0,uiMenu:{width:"w-[200px] !-mr-6"},variant:"none",size:"2xs",modelValue:u.value,"onUpdate:modelValue":a[2]||(a[2]=c=>u.value=c),options:v.options,searchable:"",multiple:"","value-attribute":"id","search-attributes":["label"]},{option:w(({option:c})=>[x("label",Je,[x("div",{class:X(["h-[14px] min-w-[18px] truncate rounded-sm px-0.5 text-xs ordinal tabular-nums leading-[14px] text-white",c.color??"bg-primary"]),style:oe(`width:${h(v.options,c.number)}px`)},[x("span",null,U(k(b)?p(v.options,c.number):c.number),1),k(b)?(E(),j("span",Ge,"%")):O("",!0)],6),x("span",Ze,U(c.label),1)])]),default:w(()=>[I(y,{size:"xs",color:"stone",variant:"link",class:"z-10 -mx-2 truncate"},{default:w(()=>[z(U(t.t.see_more),1)]),_:1})]),_:2},1032,["modelValue","options"])):O("",!0),I(V,{modelValue:k(f)[C]??v.name,options:t.filters.filter(c=>!c.component).map(c=>c.name),uiMenu:{width:"w-[200px]"},onChange:c=>k(f)[C]=k(f)[C]===c?null:c},{default:w(()=>[I(y,{icon:"i-carbon/chevron-down",size:"xs",color:"white",variant:"soft",class:"hover:text-primary-700"})]),_:2},1032,["modelValue","options","onChange"])]),x("ul",He,[(E(!0),j(D,null,A(v.options.slice(0,ie),c=>(E(),j("li",null,[x("label",{for:c.label,class:"flex flex-1 cursor-pointer select-none items-center gap-x-2 px-1 py-0.5 text-sm leading-tight text-stone-800 hover:bg-primary-100"},[x("input",{name:c.label,id:c.label,type:"checkbox",checked:o(c),onChange:M=>_(c,M),class:"h-3.5 w-3.5 flex-none cursor-pointer rounded border-stone-400 text-primary focus:ring-1 focus:ring-primary"},null,40,tt),x("div",{class:X(["h-[14px] min-w-[18px] truncate rounded-sm px-0.5 text-xs ordinal tabular-nums leading-[14px] text-white",c.color??"bg-primary"]),style:oe(`width:${h(v.options,c.number)}px`)},[x("span",null,U(k(b)?p(v.options,c.number):c.number),1),k(b)?(E(),j("span",nt,"%")):O("",!0)],6),x("span",ot,U(c.label),1)],8,et)]))),256))])],2))),256))])])])}}}),rt=()=>{const m=B(()=>navigator&&navigator.userAgent&&navigator.userAgent.match(/Macintosh;/)),u=K(" "),f=ye(),b=B(()=>{var _,o,r;const h=(_=f.value)==null?void 0:_.tagName,p=(o=f.value)==null?void 0:o.contentEditable;return h==="INPUT"||h==="TEXTAREA"||p==="true"||p==="plaintext-only"?((r=f.value)==null?void 0:r.name)||!0:!1});return xe(()=>{u.value=m.value?"âŒ˜":"Ctrl"}),{macOS:m,metaSymbol:u,activeElement:f,usingInput:b}},me=be(rt);function it(...m){return B(()=>m.every(u=>J(u)))}function ut(m){return B(()=>!J(m))}const ct=/^[^-]+.*-.*[^-]+$/,dt=/^[^_]+.*_.*[^_]+$/,pt=(m,u={})=>{const{macOS:f,usingInput:b}=me();let h=[];const p=K([]),g=()=>{p.value.splice(0,p.value.length)},_=_e(g,u.chainDelay??800),o=r=>{if(!r.key)return;const i=/^[a-z]{1}$/i.test(r.key);let s;if(p.value.push(r.key),p.value.length>=2){s=p.value.slice(-2).join("-");for(const n of h.filter(e=>e.chained))if(n.key===s){n.condition.value&&(r.preventDefault(),n.handler()),g();return}}for(const n of h.filter(e=>!e.chained))if(r.key.toLowerCase()===n.key&&r.metaKey===n.metaKey&&r.ctrlKey===n.ctrlKey&&!(i&&r.shiftKey!==n.shiftKey)){n.condition.value&&(r.preventDefault(),n.handler()),g();return}_()};h=Object.entries(m).map(([r,i])=>{var t,a;if(!i)return null;let s;r.includes("-")&&r!=="-"&&!((t=r.match(ct))!=null&&t.length)&&console.trace(`[Shortcut] Invalid key: "${r}"`),r.includes("_")&&r!=="_"&&!((a=r.match(dt))!=null&&a.length)&&console.trace(`[Shortcut] Invalid key: "${r}"`);const n=r.includes("-")&&r!=="-";if(n)s={key:r.toLowerCase(),metaKey:!1,ctrlKey:!1,shiftKey:!1,altKey:!1};else{const l=r.toLowerCase().split("_").map(d=>d);s={key:l.filter(d=>!["meta","ctrl","shift","alt"].includes(d)).join("_"),metaKey:l.includes("meta"),ctrlKey:l.includes("ctrl"),shiftKey:l.includes("shift"),altKey:l.includes("alt")}}if(s.chained=n,!f.value&&s.metaKey&&!s.ctrlKey&&(s.metaKey=!1,s.ctrlKey=!0),typeof i=="function"?s.handler=i:typeof i=="object"&&(s={...s,handler:i.handler}),!s.handler)return console.trace("[Shortcut] Invalid value"),null;const e=[];return i.usingInput?typeof i.usingInput=="string"&&e.push(B(()=>b.value===i.usingInput)):e.push(ut(b)),s.condition=it(...e,...i.whenever||[]),s}).filter(Boolean),ge("keydown",o)},ft={class:"flex flex-none flex-col items-center justify-between gap-3 md:flex-row"},mt={class:"flex flex-col"},ht={class:"truncate text-3xl font-black"},vt={class:"-mb-2 text-lg/tight text-stone-700"},bt={key:0,class:"flex md:w-[320px] lg:w-1/2"},yt={key:0,class:"flex w-full items-center pr-4"},xt={class:"mr-auto truncate"},_t={key:1},gt={class:"truncate"},kt={class:"flex items-center gap-0.5"},wt={class:"rounded border border-stone-300 bg-white px-4 py-3 shadow @container"},$t={class:"grid grid-cols-1 gap-1 @[400px]:grid-cols-2"},Vt=["for"],Et={key:0,class:"truncate"},Ct={class:"truncate"},Ut={key:0,class:"h-7"},It={class:"m-auto mr-0 flex gap-x-2"},jt=G({__name:"nx-crud-filters",props:se({filters:{}},{modelValue:{default:[]},modelModifiers:{}}),emits:["update:modelValue"],setup(m){const u=ae(m,"modelValue"),f=m,{page:b}=ke(),h=K(!1),p=K(!1);ne("retractFilter",p);const g=K({});N(g,()=>{const o=Object.values(g.value).flat();Object.equal(o,u.value)||(u.value=o)},{deep:!0}),N([u,f],()=>{const o=f.filters.reduce((i,s)=>(i[s.name]=[],i),{}),r=u.value.reduce((i,s)=>{const[n,e]=s.split("|");return i[n]||(i[n]=[]),i[n].push(s),i},o);g.value=r},{immediate:!0});const{metaSymbol:_}=me();return pt({meta_k:{usingInput:!0,handler:()=>$("#search").click()},escape:{usingInput:!0,whenever:[h],handler:()=>h.value=!1}}),(o,r)=>{const i=Z,s=je,n=pe,e=ce,t=$e,a=lt;return E(),j(D,null,[x("div",ft,[x("div",mt,[x("h1",ht,U(o.t[k(b).meta.title+"_title"]),1),x("h2",vt,U(o.t[k(b).meta.title+"_subtitle"]),1)]),o.filters.length?(E(),j("div",bt,[I(i,{class:"text-stone-600",size:"md",color:"white",icon:k(p)?"i-carbon/filter-remove":"i-carbon/filter",ui:{rounded:"rounded-r-none -mr-px"},tooltip:k(p)?o.t.show_filter:o.t.hide_filter,onClick:r[0]||(r[0]=l=>p.value=!k(p))},null,8,["icon","tooltip"]),I(n,{id:"search",name:"search",class:"w-[calc(100%-80px)]",ui:{rounded:"rounded-none z-10"},icon:"i-carbon/search",size:"lg",searchable:"",multiple:"",placeholder:o.t.search,modelValue:u.value,"onUpdate:modelValue":r[2]||(r[2]=l=>u.value=l),"value-attribute":"id","search-attributes":["filter","label"],options:o.filters.flatMap(l=>l.options)},{label:w(()=>[u.value.length?(E(),j("div",yt,[x("div",xt,U(u.value.map(l=>l.split("|")[1]).join(", ")),1),I(i,{class:"-my-1 mx-1",variant:"solid",size:"2xs",color:"stone",onClick:r[1]||(r[1]=we(l=>u.value=[],["stop"]))},{default:w(()=>[z(U(o.t.reset),1)]),_:1})])):(E(),j("span",_t,"Add filter"))]),option:w(({option:l})=>[x("span",gt,[x("b",null,U(l.filter),1),z(" | "+U(l.label||"-"),1)])]),trailing:w(()=>[x("div",kt,[I(s,null,{default:w(()=>[z(U(k(_)),1)]),_:1}),I(s,null,{default:w(()=>r[6]||(r[6]=[z("K")])),_:1})])]),_:1},8,["placeholder","modelValue","options"]),I(t,{open:k(h),"onUpdate:open":r[4]||(r[4]=l=>R(h)?h.value=l:null),popper:{placement:"bottom-end"},ui:{container:"w-2/3 lg:w-1/2 mr-1"}},{panel:w(({close:l})=>[x("div",wt,[x("div",$t,[(E(!0),j(D,null,A(o.filters,d=>(E(),j("div",{class:"grid grid-cols-[35%_65%] gap-x-2",key:d.name},[x("label",{for:d.name,class:"place-self-end self-center text-right text-sm font-medium"},U(d.name.format()),9,Vt),I(e,{id:d.name,searchable:"",multiple:"",modelValue:k(g)[d.name],"onUpdate:modelValue":y=>k(g)[d.name]=y,options:d.options,"value-attribute":"id","search-attributes":["label"]},{label:w(()=>[k(g)[d.name].length?(E(),j("div",Et,U(k(g)[d.name].map(y=>y.split("|")[1]).join(", ")),1)):O("",!0)]),option:w(({option:y})=>[x("span",Ct,U(y.label||"-"),1)]),_:2},1032,["id","modelValue","onUpdate:modelValue","options"])]))),128)),o.filters.length%2===0?(E(),j("div",Ut)):O("",!0),x("div",It,[I(i,{variant:"solid",size:"2xs",color:"stone",onClick:r[3]||(r[3]=d=>u.value=[])},{default:w(()=>[z(U(o.t.reset),1)]),_:1})])])])]),default:w(()=>[I(i,{class:"text-stone-600",icon:"i-carbon/chevron-down",size:"md",color:"white",ui:{rounded:"rounded-l-none -ml-px"}})]),_:1},8,["open"])])):O("",!0)]),!k(p)&&o.filters.length?(E(),P(a,{key:0,modelValue:u.value,"onUpdate:modelValue":r[5]||(r[5]=l=>u.value=l),filters:o.filters},null,8,["modelValue","filters"])):O("",!0)],64)}}}),Mt={class:"flex min-h-[620px] flex-col p-4"},Ot={class:"flex"},St={class:"flex flex-1 items-center gap-1"},zt=["onClick"],Kt={key:0,class:"mx-1 text-stone-200"},Ft={class:"flex h-full flex-1 flex-col gap-4 p-4"},Pt={class:"mt-auto flex items-center justify-end gap-2 pt-5"},At=G({__name:"nx-crud-popup",props:se({options:{}},{modelValue:{type:Boolean},modelModifiers:{}}),emits:["update:modelValue"],setup(m){const u=ae(m,"modelValue"),{data:f}=fe("specialties"),b=K(m.options.tabs.flatMap(n=>n.components.filter(e=>e.component!=="none")));function h(){return m.options.tabs.reduce((n,e)=>(e.components.forEach(t=>{if(t.default==="now")return n[t.key]=new Date;if(t.default)return n[t.key]=t.default;n[t.key]={NxPickExcept:{mode:"PICK",list:[]}}[t.component??"UInput"]}),n),{})}const p=K(),g=K(h()),_=K(0);N([f,g],()=>{var t,a;(t=p.value)!=null&&t.getErrors().length&&p.value.validate((a=p.value)==null?void 0:a.getErrors().map("path")).catch(()=>null);const n=(l=[],d,y=V=>V)=>l.reduce((V,v)=>(V[v[d]]=y(v),V),{}),e=n(b.value,"key");b.value=b.value.map(l=>{var M;const[d,y,V]=((M=/([^:]*):([^(]*)\(?([^)]*)\)?/.exec(l.url))==null?void 0:M.slice(1))??[];if(d!=="specialty")return l;const v=V?V.split(","):[],C=f.value[0].datapoints[y];if(!C)return l;const c=v.reduce((F,S)=>{if(e[S].component==="NxPickExcept"){const W=e[S].options;g.value[S].mode==="ALL"&&(F[S]=W),g.value[S].mode==="PICK"&&(F[S]=g.value[S].list),g.value[S].mode==="EXCEPT"&&(F[S]=W.filter(H=>!g.value[S].list.includes(H))),F[S]=n(F[S],"id",()=>!0)}return F},{});return l.options=C(V?c:null),l})},{deep:!0}),N(_,async(n,e)=>{var t;if(!(e>n))try{await((t=p.value)==null?void 0:t.validate(m.options.tabs.slice(e,n).flatMap(a=>a.components.map(l=>l.key))))}catch{r(p.value)}}),N(()=>$cfg.line,()=>{g.value=$cfg.line});async function o(n){const e=[];return m.options.tabs.flatMap(t=>t.components).forEach(t=>{t.required&&!n[t.key]&&e.push({path:t.key,message:"Required"}),t.component==="NxPickExcept"&&t.required&&n[t.key].mode==="PICK"&&!n[t.key].list.length&&e.push({path:t.key,message:"Required"})}),e}async function r(n){_.value=m.options.tabs.findIndex(e=>e.components.find(t=>t.key===n.errors[0].path)),de(()=>{const e=document.getElementById(n.errors[0].path);e==null||e.setAttribute("tabindex","0"),e==null||e.focus(),e==null||e.scrollIntoView({behavior:"smooth",block:"center"})})}async function i(n){console.log(n.data),g.value=h(),u.value=!1}function s(){g.value=h(),u.value=!1}return(n,e)=>{const t=Z,a=Oe,l=Se,d=ze;return E(),P(d,{modelValue:u.value,"onUpdate:modelValue":e[3]||(e[3]=y=>u.value=y)},{default:w(()=>[x("div",Mt,[x("div",Ot,[x("div",St,[(E(!0),j(D,null,A(n.options.tabs,(y,V)=>(E(),j("div",{class:"flex items-center",key:`production-${V}`},[x("div",{class:X(["select-none text-sm font-medium",k(_)===V?"text-primary":"cursor-pointer text-stone-400 hover:text-stone-800"]),onClick:v=>_.value=V},U(y.name),11,zt),V!==n.options.tabs.length-1?(E(),j("span",Kt,"/")):O("",!0)]))),128))]),I(t,{size:"md",color:"gray",variant:"ghost",icon:"i-carbon/close",class:"flex-none",onClick:e[0]||(e[0]=y=>s())})]),I(l,{state:k(g),validate:o,onError:r,onSubmit:i,ref_key:"form",ref:p},{default:w(()=>[x("div",Ft,[(E(!0),j(D,null,A(k(b).filter(y=>n.options.tabs[k(_)].components.find(V=>V.key===y.key)),y=>(E(),P(a,{id:y.key,name:y.key,label:y.key.format()},{default:w(()=>[(E(),P(Ve(y.component??"UInput"),le({modelValue:k(g)[y.key],"onUpdate:modelValue":V=>k(g)[y.key]=V,ref_for:!0},y),T({_:2},[A(Object.keys(n.$slots),V=>({name:V,fn:w(v=>[L(n.$slots,V,le({item:y,ref_for:!0},v))])}))]),1040,["modelValue","onUpdate:modelValue"]))]),_:2},1032,["id","name","label"]))),256)),x("div",Pt,[k(_)>0?(E(),P(t,{key:0,onClick:e[1]||(e[1]=y=>_.value--),variant:"ghost",size:"md",color:"stone",ui:{rounded:"rounded-full"}},{default:w(()=>[z(U(n.t.back),1)]),_:1})):O("",!0),k(_)<n.options.tabs.length-1?(E(),P(t,{key:1,onClick:e[2]||(e[2]=y=>_.value++),size:"md",ui:{rounded:"rounded-full"}},{default:w(()=>[z(U(n.t.next),1)]),_:1})):O("",!0),k(_)===n.options.tabs.length-1?(E(),P(t,{key:2,type:"submit",size:"md",ui:{rounded:"rounded-full"}},{default:w(()=>[z(U(n.t.confirm),1)]),_:1})):O("",!0)])])]),_:3},8,["state"])])]),_:3},8,["modelValue"])}}}),te=new WeakMap;function ue(m,u,f={}){const{mode:b="replace",route:h=Ee(),router:p=Ce(),transform:g=s=>s}=f;te.has(p)||te.set(p,new Map);const _=te.get(p);let o=h.query[m];Ie(()=>{o=void 0});let r;const i=Ue((s,n)=>(r=n,{get(){return s(),g(o!==void 0?o:J(u))},set(e){o!==e&&(o=e===u||e===null?void 0:e,_.set(m,e===u||e===null?void 0:e),n(),de(()=>{if(_.size===0)return;const t=Object.fromEntries(_.entries());_.clear();const{params:a,query:l,hash:d}=h;p[J(b)]({params:a,query:{...l,...t},hash:d})}))}}));return N(()=>h.query[m],s=>{o!==s&&(o=s,r())},{flush:"sync"}),i}function Nt(){const m=ue("tab","0",{transform:Number}),u=ue("filters"),f=K(Dt(u.value));return N(f,b=>u.value=qt(b),{deep:!0}),{urlTab:m,urlFilters:f}}function qt(m){let u="";return m.slice().sort().reduce((f,b)=>{const[h,p]=b.split("|");return u!==h&&(u=h,f+=(f?"||":"")+h),f+="|"+p,f},"")}function Dt(m){return m?m.split("||").flatMap(u=>{const[f,...b]=u.split("|");return b.map(h=>f+"|"+h)}):[]}function Bt({data:m,dimensions:u}){const f={data:m,dimensions:u,setup(){f.status=[];const{data:b,dimensions:h,status:p}=f;h.forEach((o,r)=>{o.mask=1<<r,o.map=o.map||(i=>i[o.name]),o.filter&&(o.breakdown={})});const g=h.filter(({filter:o})=>o),_=h.filter(({inc:o})=>o);b.forEach((o,r)=>(p[r]=0,g.forEach(({filter:i,breakdown:s,mask:n,map:e})=>{const t=e(o);if(s[t]||(s[t]=[]),s[t].push(r),i(t,o))return s[t].on=!0;s[t].on=!1,p[r]|=n}),p[r]===0?_.forEach(({inc:i})=>i(f,o)):g.forEach(({mask:i,inc:s})=>{!s||p[r]!==i||s(f,o)})))},filter(b,h){const{data:p,dimensions:g,status:_}=f,o=g.find(i=>i.name===b),r=g.filter(({name:i,inc:s})=>s&&o.name!==i);if(o.filter!==h){if(h?o.filter=h:delete o.filter,!o.breakdown)return o.breakdown={},p.forEach((i,s)=>{const n=o.map(i);if(o.breakdown[n]||(o.breakdown[n]=[]),o.breakdown[n].push(s),o.filter(n,i))return o.breakdown[n].on=!0;o.breakdown[n].on=!1,_[s]===0?r.forEach(({dec:e})=>e(f,p[s])):r.forEach(({mask:e,dec:t})=>{_[s]===e&&t(f,p[s])}),_[s]|=o.mask});h||(h=()=>!0),Object.entries(o.breakdown).forEach(([i,s])=>{const n=s.on;if(s.on=h(i),s.on!==n){if(s.on)return s.forEach(e=>{_[e]&=~o.mask,_[e]===0?r.forEach(({mask:t,inc:a})=>{if(o.mask!==t)return a(f,p[e])}):r.forEach(({mask:t,inc:a})=>{if(_[e]===t)return a(f,p[e])})});s.forEach(e=>{_[e]===0?r.forEach(({dec:t})=>t(f,p[e])):r.forEach(({mask:t,dec:a})=>{_[e]===t&&a(f,p[e])}),_[e]|=o.mask})}})}},clear(){f.dimensions.forEach(b=>f.filter(b.name))}};return f.setup(),f}function Rt(m,u,f=[]){let b;const h=re([]),p=re([]);if(!f.length)return{xdata:m,xfilters:p};const g=f.map((i,s)=>{const n=i.key;return{key:n,name:n,inc:(e,t)=>{e.breakdown||(e.breakdown={}),e.breakdown[n]||(e.breakdown[n]={}),e.breakdown[n][t[n]]||(e.breakdown[n][t[n]]=0),e.breakdown[n][t[n]]++},dec:(e,t)=>{e.breakdown||(e.breakdown={}),e.breakdown[n]||(e.breakdown[n]={}),e.breakdown[n][t[n]]||(e.breakdown[n][t[n]]=0),e.breakdown[n][t[n]]--}}});return N(m,_,{immediate:!0}),N(u,r,{immediate:!0}),{xdata:h,xfilters:p};function _(){b=Bt({data:m.value,dimensions:g}),r()}function o(i,s){if(!s||!s.length)return b.filter(i,null);const n=s.reduce((e,t)=>(e[t]=!0,e),{undefined:!0});b.filter(i,e=>n[e])}function r(){b.clear(),Object.entries(u.value).forEach(([i,s])=>o(i,s)),h.value=b.status.reduce((i,s,n)=>(!s&&i.push(b.data[n]),i),[]),p.value=Object.entries(b.breakdown??{}).map(([i,s])=>{const{sort:n,color:e,component:t}=f.find(d=>d.key===i)||{},a=Array.isArray(n)?[d=>-n.slice().reverse().indexOf(d.label),"-number"]:n||["-number","label"],l=Object.entries(s).filter(([d,y])=>!(d==="null"||d==="undefined")).map(([d,y])=>({id:`${i}|${d}`,filter:i,label:d.replace("undefined","-"),number:y,color:e==null?void 0:e[d]}));return{name:i,options:l.sort(a),component:t}})}}const Tt={class:"flex items-center gap-2"},Lt={class:"flex items-center gap-2"},on=G({__name:"nx-crud-page",props:{options:{}},setup(m){const{data:u}=fe(m.options.object),f=B(()=>m.options.translations?u.value.map(e=>Object.entries(m.options.translations).reduce((t,[a,l])=>(t[l]=window.access(e,a)??"-",t),e)):u.value),{urlTab:b,urlFilters:h}=Nt(),p=K({}),{xdata:g,xfilters:_}=Rt(f,p,m.options.filters);N(()=>{var t;const e=h.value.reduce((a,l)=>{const[d,y]=l.split("|");return a[d]||(a[d]=[]),a[d].push(y),a},{});return(t=m.options.filters)==null||t.forEach(a=>{var y,V;if(e[a.key]||!a.select)return;const l={first:0,last:-1,tab:b.value}[a.select],d=(V=(y=_.value.find(v=>v.name===a.key))==null?void 0:y.options.at(l))==null?void 0:V.label;d&&(e[a.key]=Object.assign([d],{initial:!0,ignore:a.component==="none"}))}),e},e=>{if(JSON.stringify(e)===JSON.stringify(p.value))return;p.value=e;const t=Object.entries(p.value).flatMap(([a,l])=>!l.initial||l.ignore?[]:l.map(d=>`${a}|${d}`));t.length!==0&&(h.value=h.value.concat(t))},{immediate:!0});const o=K(!1),r=B(()=>({object:m.options.object,...m.options.popup}));function i(e){return m.options.popup?{onImport:a=>l=>{const y=((V,v,C=c=>c)=>V.reduce((c,M)=>(c[M[v]]=C(M),c),{}))(m.options.popup.tabs.flatMap(V=>V.components),"label");l.forEach(V=>{const v=Object.entries(V).reduce((C,[c,M])=>{const F=y[c],S={datetime:q=>q.format("YYYY-MM-DD hh:mm:ss"),date:q=>q.format(),time:q=>q.format("hh:mm")},W=F==null?void 0:F.type,H=S[W]??(q=>q),he=F?F.key:c,ve=H(M);return C[he]=ve,C},{});if(!v.id)return ee.database.create(m.options.object,v);ee.database.update(m.options.object,v)})},...e}:e}async function s(e,t){$cfg.line=e.dataMap.list.find(a=>a.id===t.id)._data,o.value=!0}async function n(e){e.forEach(t=>ee.database.delete(m.options.object,t))}return(e,t)=>{const a=jt,l=At,d=Z,y=Ke,V=Fe,v=Pe;return E(),P(v,null,{header:w(()=>[I(a,{modelValue:k(h),"onUpdate:modelValue":t[0]||(t[0]=C=>R(h)?h.value=C:null),filters:k(_).filter(C=>C.component!=="none")},null,8,["modelValue","filters"])]),default:w(()=>[e.options.grid?(E(),P(y,{key:0,class:"h-full min-h-[400px] rounded tabular-nums shadow",data:k(g),options:i(e.options.grid)},T({_:2},[A(Object.keys(e.$slots),C=>({name:C,fn:w(c=>[L(e.$slots,C,Y(Q(c)))])})),e.options.popup?{name:"crud",fn:w(({state:C})=>[x("div",Tt,[I(l,{options:k(r),modelValue:k(o),"onUpdate:modelValue":t[1]||(t[1]=c=>R(o)?o.value=c:null)},T({_:2},[A(Object.keys(e.$slots),c=>({name:c,fn:w(M=>[L(e.$slots,c,Y(Q(M)))])}))]),1032,["options","modelValue"]),I(d,{icon:"i-carbon/add",size:"2xs",color:"primary",variant:"solid",onClick:t[2]||(t[2]=c=>o.value=!0)},{default:w(()=>[z(U(e.t.create),1)]),_:1}),I(d,{icon:"i-carbon/trash-can",size:"2xs",color:"red",variant:"solid",onClick:c=>n(C.selection.items.list)},{default:w(()=>[z(U(e.t.delete),1)]),_:2},1032,["onClick"])])]),key:"0"}:void 0,e.options.popup?{name:"line-addon",fn:w(({state:C,item:c,isItemHover:M})=>[M?(E(),j("div",{key:0,class:"absolute top-0 z-50 flex h-7 -translate-x-full items-center px-2",style:oe({left:`${C.columns.headers.list[0].width+24}px`})},[I(d,{icon:"i-carbon/edit",size:"2xs",variant:"solid",tooltip:"edit",onClick:F=>s(C,c)},null,8,["onClick"])],4)):O("",!0)]),key:"1"}:void 0]),1032,["data","options"])):O("",!0),e.options.tabs?(E(),P(V,{key:1,items:e.options.tabs,modelValue:k(b),"onUpdate:modelValue":t[5]||(t[5]=C=>R(b)?b.value=C:null),unmount:!0},{item:w(({item:C})=>[I(y,{class:"h-full min-h-[400px] rounded rounded-tl-none tabular-nums shadow",data:k(g),options:i(C)},T({_:2},[A(Object.keys(e.$slots),c=>({name:c,fn:w(M=>[L(e.$slots,c,Y(Q(M)))])})),e.options.popup?{name:"crud",fn:w(()=>[x("div",Lt,[I(l,{options:k(r),modelValue:k(o),"onUpdate:modelValue":t[3]||(t[3]=c=>R(o)?o.value=c:null)},T({_:2},[A(Object.keys(e.$slots),c=>({name:c,fn:w(M=>[L(e.$slots,c,Y(Q(M)))])}))]),1032,["options","modelValue"]),e.options.popup?(E(),P(d,{key:0,icon:"i-carbon/add",size:"2xs",color:"primary",variant:"solid",onClick:t[4]||(t[4]=c=>o.value=!0)},{default:w(()=>[z(U(e.t.create),1)]),_:1})):O("",!0),I(d,{icon:"i-carbon/trash-can",size:"2xs",color:"red",variant:"solid"},{default:w(()=>[z(U(e.t.delete),1)]),_:1})])]),key:"0"}:void 0]),1032,["data","options"])]),_:3},8,["items","modelValue"])):O("",!0)]),_:3})}}});export{on as _};
